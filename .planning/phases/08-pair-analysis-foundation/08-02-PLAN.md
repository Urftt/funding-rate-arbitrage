---
phase: 08-pair-analysis-foundation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/bot/dashboard/routes/pages.py
  - src/bot/dashboard/templates/pairs.html
  - src/bot/dashboard/templates/base.html
autonomous: true

must_haves:
  truths:
    - "User can navigate to /pairs from the nav bar"
    - "User can view a ranking table of all tracked pairs sorted by fee-adjusted annualized yield"
    - "Ranking table shows symbol, record count, avg rate, median, std dev, pct positive, net yield, annualized yield"
    - "Pairs with insufficient data display a 'Low data' badge"
    - "User can click date range buttons (7d, 30d, 90d, all) and the ranking table updates"
    - "User can click a pair to see a detail panel with stats cards and a funding rate time series chart"
  artifacts:
    - path: "src/bot/dashboard/templates/pairs.html"
      provides: "Pair explorer page template with ranking table, detail panel, Chart.js chart, and date range buttons"
      min_lines: 80
    - path: "src/bot/dashboard/routes/pages.py"
      provides: "GET /pairs page route"
      contains: "/pairs"
    - path: "src/bot/dashboard/templates/base.html"
      provides: "Navigation link to /pairs"
      contains: "/pairs"
  key_links:
    - from: "src/bot/dashboard/templates/pairs.html"
      to: "/api/pairs/ranking"
      via: "vanilla JS fetch() for ranking data"
      pattern: "fetch.*pairs/ranking"
    - from: "src/bot/dashboard/templates/pairs.html"
      to: "/api/pairs/{symbol}/stats"
      via: "vanilla JS fetch() for per-pair detail"
      pattern: "fetch.*pairs/"
    - from: "src/bot/dashboard/routes/pages.py"
      to: "src/bot/dashboard/templates/pairs.html"
      via: "Jinja2Templates.TemplateResponse"
      pattern: "pairs.html"
---

<objective>
Create the Pair Explorer dashboard page with a ranking table, per-pair detail panel with Chart.js time series chart, date range filter buttons, and navigation link.

Purpose: Gives users a visual interface to browse and compare pairs by historical profitability, fulfilling EXPR-01, EXPR-02, EXPR-03, EXPR-05, and EXPR-06.

Output: /pairs page route, pairs.html template with ranking table, detail panel, time series chart, date range filtering, and nav link in base.html.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-pair-analysis-foundation/08-01-SUMMARY.md
@src/bot/dashboard/routes/pages.py
@src/bot/dashboard/templates/base.html
@src/bot/dashboard/templates/backtest.html
@src/bot/dashboard/templates/partials/equity_curve.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Page route, template structure, and navigation link</name>
  <files>src/bot/dashboard/routes/pages.py, src/bot/dashboard/templates/pairs.html, src/bot/dashboard/templates/base.html</files>
  <action>
**1. Add /pairs route to `src/bot/dashboard/routes/pages.py`:**

Add a new page route after the backtest_page route, following the same pattern:
```python
@router.get("/pairs", response_class=HTMLResponse)
async def pairs_page(request: Request) -> HTMLResponse:
    """Pair Explorer page for browsing historical funding rate profitability (EXPR-01)."""
    templates: Jinja2Templates = request.app.state.templates
    return templates.TemplateResponse("pairs.html", {"request": request})
```
No server-side data needed -- the page loads data via client-side fetch() to the API endpoints.

**2. Create `src/bot/dashboard/templates/pairs.html`:**

Extends `base.html`. Include Chart.js CDN in head block. Build the complete HTML structure:

- **Head block**: Include `<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>`

- **Content block** with `<div class="space-y-6">`:
  - Header row with `<h2>Pair Explorer</h2>` and date range button group (7D, 30D, 90D, All)
  - Date range buttons: each `<button data-range="7d|30d|90d|all">` styled with Tailwind. "All" starts as active (bg-blue-600 text-white). Others: bg-dash-card text-gray-400 border border-dash-border hover:text-white
  - Loading indicator div (spinner, shown initially)
  - Ranking table in a bg-dash-card container with overflow-x-auto. Table columns:
    - # (rank number)
    - Pair (symbol name, clickable)
    - Records (count, with "Low data" badge space)
    - Avg Rate (right-aligned)
    - Median (right-aligned)
    - Std Dev (right-aligned)
    - % Positive (right-aligned)
    - Net Yield/Period (right-aligned)
    - Ann. Yield (right-aligned)
  - Empty tbody with id="ranking-body" (populated by JS)
  - Per-pair detail section (hidden initially) with:
    - Header with pair name and Close button
    - Stats grid (2 cols mobile, 4 cols desktop) with id="detail-stats"
    - Chart container div (height 300px) with `<canvas id="funding-rate-chart"></canvas>`
  - Empty state div for when no data is available

**3. Update `src/bot/dashboard/templates/base.html`:**

Add "Pairs" link to the nav bar. Insert between "Dashboard" and "Backtest":
```html
<a href="/pairs" class="text-gray-400 hover:text-white text-sm">Pairs</a>
```
  </action>
  <verify>
Run: `python -c "from bot.dashboard.routes.pages import router; print('OK')"`
Run: `ls src/bot/dashboard/templates/pairs.html`
Run: `grep '/pairs' src/bot/dashboard/templates/base.html`
All should succeed.
  </verify>
  <done>GET /pairs route serves pairs.html. Template structure has ranking table, detail panel, chart container, date range buttons, and loading/empty states. Nav bar has /pairs link.</done>
</task>

<task type="auto">
  <name>Task 2: JavaScript for data fetching, table rendering, detail panel, and chart</name>
  <files>src/bot/dashboard/templates/pairs.html</files>
  <action>
Add a `{% block scripts %}` section to pairs.html with a self-executing function (following backtest.html IIFE pattern). Include all interaction logic:

**a. State variables:**
```javascript
let currentRange = 'all';
let currentSymbol = null;
```

**b. `fetchRanking(range)` function:**
- Set `currentRange = range`
- Show loading indicator, hide ranking section and empty state
- `fetch('/api/pairs/ranking?range=' + range)`
- On success (JSON array):
  - If empty, show empty state, return
  - Build table rows for `#ranking-body`. Each row:
    - Rank: index + 1
    - Symbol: `<span class="cursor-pointer text-blue-400 hover:text-blue-300" onclick="window._showDetail('${symbol}')">${symbol}</span>`
    - Records: count value. If `has_sufficient_data` is false, append: `<span class="ml-1 text-xs bg-yellow-600/30 text-yellow-400 px-1.5 py-0.5 rounded">Low data</span>`
    - Avg Rate: format as `(parseFloat(val) * 100).toFixed(4) + '%'`
    - Median: same format
    - Std Dev: same format
    - % Positive: `(parseFloat(val) * 100).toFixed(1) + '%'`
    - Net Yield/Period: percentage format with green (positive) or red (negative) color class
    - Annualized Yield: percentage format with green/red color
  - Set innerHTML of `#ranking-body`
  - Hide loading, show ranking section
- On error: show error message in empty state area

**c. Date range button click handlers:**
- Select all `[data-range]` buttons, add click listener to each
- On click:
  - Remove active style from all buttons (set to bg-dash-card text-gray-400 border border-dash-border)
  - Add active style to clicked button (bg-blue-600 text-white, remove border)
  - Call `fetchRanking(button.dataset.range)`
  - If detail panel is visible and currentSymbol is set, also call `fetchDetail(currentSymbol)`

**d. `window._showDetail(symbol)` function** (on window so onclick works from innerHTML):
- Set `currentSymbol = symbol`
- `fetch('/api/pairs/' + encodeURIComponent(symbol) + '/stats?range=' + currentRange)`
- On success:
  - Show `#pair-detail` section
  - Set `#detail-title` text to symbol
  - Fill `#detail-stats` with metric cards (following backtest.html metricCard pattern):
    - "Avg Rate" with value formatted as percentage
    - "Median Rate" with value formatted as percentage
    - "Std Dev" with value formatted as percentage
    - "% Positive" with value formatted as percentage
    - "Net Yield/Period" with green/red coloring
    - "Ann. Yield" with green/red coloring
    - "Records" with count value
  - Each card: `<div class="bg-dash-bg rounded-lg border border-dash-border p-3"><p class="text-xs text-gray-400 mb-1">${label}</p><p class="text-lg font-semibold ${colorClass}">${value}</p></div>`
  - If `time_series` array exists and has data, call `renderFundingRateChart(data.time_series)`
  - Scroll detail section into view: `document.getElementById('pair-detail').scrollIntoView({behavior: 'smooth'})`

**e. `renderFundingRateChart(timeSeries)` function:**
Follow the exact pattern from `equity_curve.html`:
- Get canvas context from `#funding-rate-chart`
- Destroy previous chart if `window._fundingChart` exists
- Labels: map timestamps to formatted dates using `toLocaleDateString('en-US', { month: 'short', day: 'numeric' })`
- Values: map funding_rate strings to `parseFloat(val) * 100` (display as percentage)
- Create Chart.js line chart:
  - type: 'line'
  - borderColor: '#3b82f6' (blue)
  - backgroundColor: '#3b82f61a'
  - borderWidth: 2, fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 4
  - responsive: true, maintainAspectRatio: false, animation: { duration: 0 }
  - X-axis: ticks color #6b7280, maxTicksLimit: 15, grid color #334155
  - Y-axis: ticks color #6b7280, callback `v + '%'`, grid color #334155
  - Tooltip: mode 'index', intersect false, label callback showing rate with 4 decimal places + '%'
  - Legend labels color #9ca3af
- Show `#chart-container`
- Store chart as `window._fundingChart`

**f. Close detail button:**
- `document.getElementById('close-detail').addEventListener('click', ...)`:
  - Hide `#pair-detail`
  - Set currentSymbol to null
  - Destroy chart if exists

**g. Initial load:**
Call `fetchRanking('all')` at end of IIFE.

**Important implementation notes:**
- Use `'use strict';` at top of IIFE
- All numeric formatting uses parseFloat() on string values (Decimals come as strings from API)
- Row click handler uses `window._showDetail` (global) since rows are built via innerHTML
- Handle fetch errors gracefully with try/catch or .catch()
  </action>
  <verify>
Verify the JavaScript is syntactically valid by checking pairs.html contains the key functions:
- `grep 'fetchRanking' src/bot/dashboard/templates/pairs.html`
- `grep 'renderFundingRateChart' src/bot/dashboard/templates/pairs.html`
- `grep '_showDetail' src/bot/dashboard/templates/pairs.html`
All should return matches.
  </verify>
  <done>Page loads ranking data on init via fetch(). Date range buttons update the ranking table. Clicking a pair shows detail panel with stats cards and Chart.js time series chart. Chart follows equity_curve.html pattern with pre-formatted date labels. All data displayed as formatted percentages.</done>
</task>

</tasks>

<verification>
1. `python -c "from bot.dashboard.routes.pages import router; print('OK')"` succeeds
2. `ls src/bot/dashboard/templates/pairs.html` -- file exists with both HTML structure and JS
3. `grep -c '/pairs' src/bot/dashboard/templates/base.html` -- returns at least 1
4. `grep 'fetchRanking' src/bot/dashboard/templates/pairs.html` -- function exists
5. `grep 'renderFundingRateChart' src/bot/dashboard/templates/pairs.html` -- function exists
6. `python -m pytest tests/ -x -q` -- all existing tests pass
</verification>

<success_criteria>
- /pairs route exists and serves pairs.html template
- base.html nav includes link to /pairs between Dashboard and Backtest
- Ranking table has all 9 columns (rank, symbol, records, avg rate, median, std dev, % positive, net yield, annualized yield)
- "Low data" badge appears for pairs where has_sufficient_data is false
- Date range buttons (7d, 30d, 90d, all) trigger API re-fetch and rebuild table
- Clicking a pair row opens detail panel with stat cards and Chart.js time series chart
- Chart shows funding rates as percentage over time with formatted date labels
- All rate values displayed as percentages (multiplied by 100)
- No new Python dependencies added
- Chart.js CDN included in head block (same version as backtest page)
</success_criteria>

<output>
After completion, create `.planning/phases/08-pair-analysis-foundation/08-02-SUMMARY.md`
</output>
