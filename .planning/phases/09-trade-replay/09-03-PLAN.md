---
phase: 09-trade-replay
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - src/bot/dashboard/templates/partials/equity_curve.html
  - src/bot/dashboard/templates/partials/pnl_histogram.html
  - src/bot/dashboard/templates/backtest.html
autonomous: true

must_haves:
  truths:
    - "User can see green triangle markers at trade entry points on the equity curve chart"
    - "User can see red inverted triangle markers at trade exit points on the equity curve chart"
    - "User can hover over trade markers to see trade number, date, and equity value in tooltip"
    - "User can see a P&L distribution histogram (bar chart) showing how many trades fell at each profit/loss level"
    - "Histogram bars are green for positive P&L bins and red for negative P&L bins"
    - "Charts handle edge cases: no trades shows no markers, no histogram"
  artifacts:
    - path: "src/bot/dashboard/templates/partials/equity_curve.html"
      provides: "renderEquityCurve extended to accept optional trades array and overlay scatter datasets"
      contains: "scatter"
    - path: "src/bot/dashboard/templates/partials/pnl_histogram.html"
      provides: "P&L distribution histogram using Chart.js bar chart"
      contains: "pnl-histogram"
    - path: "src/bot/dashboard/templates/backtest.html"
      provides: "JS calls to render trade markers and histogram from API response"
      contains: "renderPnlHistogram"
  key_links:
    - from: "src/bot/dashboard/templates/partials/equity_curve.html"
      to: "BacktestResult.to_dict() trades field"
      via: "renderEquityCurve receives trades array and maps entry/exit timestamps to equity curve indices"
      pattern: "trades\\.map|entryPoints|exitPoints"
    - from: "src/bot/dashboard/templates/partials/pnl_histogram.html"
      to: "BacktestResult.to_dict() pnl_histogram field"
      via: "renderPnlHistogram reads bins and counts from server-computed histogram data"
      pattern: "pnl_histogram\\.bins|pnl_histogram\\.counts"
    - from: "src/bot/dashboard/templates/backtest.html"
      to: "equity_curve.html and pnl_histogram.html"
      via: "displaySingleResult calls renderEquityCurve with trades and renderPnlHistogram"
      pattern: "renderEquityCurve.*trades|renderPnlHistogram"
---

<objective>
Add trade entry/exit markers as scatter points overlaid on the equity curve chart, and a P&L distribution histogram as a new bar chart. These visualizations help users see at a glance when trades happened relative to equity changes and how trade outcomes are distributed.

Purpose: TRPL-04 (trade markers on equity curve), TRPL-05 (P&L distribution histogram). These are the final visual components completing the trade replay feature.
Output: Modified equity_curve.html with scatter datasets, new pnl_histogram.html partial, updated backtest.html wiring.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-trade-replay/09-RESEARCH.md
@.planning/phases/09-trade-replay/09-01-SUMMARY.md
@.planning/phases/09-trade-replay/09-02-SUMMARY.md
@src/bot/dashboard/templates/partials/equity_curve.html
@src/bot/dashboard/templates/backtest.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trade markers to equity curve and create P&L histogram</name>
  <files>
    src/bot/dashboard/templates/partials/equity_curve.html
    src/bot/dashboard/templates/partials/pnl_histogram.html
    src/bot/dashboard/templates/backtest.html
  </files>
  <action>
**Modify `renderEquityCurve()` in `equity_curve.html`:**

Change the function signature to accept an optional trades parameter:
```javascript
function renderEquityCurve(equityData, label, color, trades) {
```

After building `labels` and `values` arrays (existing code), add trade marker logic:

1. Build a timestamp-to-index lookup from equityData:
   ```javascript
   var tsToIndex = {};
   equityData.forEach(function(p, idx) { tsToIndex[p.timestamp_ms] = idx; });
   ```

2. Build entry and exit point arrays from trades (if provided and non-empty):
   ```javascript
   var entryPoints = [];
   var exitPoints = [];
   if (trades && trades.length > 0) {
       trades.forEach(function(t) {
           // Find closest equity curve index for entry
           var entryIdx = tsToIndex[t.entry_time_ms];
           if (entryIdx !== undefined) {
               entryPoints.push({ x: entryIdx, y: values[entryIdx] });
           }
           // Find closest equity curve index for exit
           var exitIdx = tsToIndex[t.exit_time_ms];
           if (exitIdx !== undefined) {
               exitPoints.push({ x: exitIdx, y: values[exitIdx] });
           }
       });
   }
   ```
   Note: entry/exit timestamps should match equity curve timestamps exactly since both are recorded at funding rate timestamps. If no exact match, skip the marker (graceful degradation).

3. Build datasets array. Start with the existing equity line dataset, then conditionally add scatter datasets:
   ```javascript
   var datasets = [{
       label: label || 'Equity',
       data: values,
       borderColor: color || '#22c55e',
       backgroundColor: (color || '#22c55e') + '1a',
       borderWidth: 2,
       fill: true,
       tension: 0.3,
       pointRadius: 0,
       pointHoverRadius: 4,
   }];

   if (entryPoints.length > 0) {
       datasets.push({
           type: 'scatter',
           label: 'Entry',
           data: entryPoints,
           pointStyle: 'triangle',
           pointRadius: 7,
           pointHoverRadius: 10,
           backgroundColor: '#22c55e',
           borderColor: '#166534',
           borderWidth: 1,
           showLine: false,
       });
   }

   if (exitPoints.length > 0) {
       datasets.push({
           type: 'scatter',
           label: 'Exit',
           data: exitPoints,
           pointStyle: 'triangle',
           rotation: 180,
           pointRadius: 7,
           pointHoverRadius: 10,
           backgroundColor: '#ef4444',
           borderColor: '#991b1b',
           borderWidth: 1,
           showLine: false,
       });
   }
   ```

4. Use `datasets` array in Chart construction (replace the existing hardcoded single dataset):
   ```javascript
   window._equityChart = new Chart(ctx, {
       type: 'line',
       data: { labels: labels, datasets: datasets },
       options: { ... }  // Keep existing options unchanged
   });
   ```

5. Enhance tooltip callback to show more detail for scatter points:
   ```javascript
   callbacks: {
       label: function(context) {
           if (context.dataset.type === 'scatter') {
               return context.dataset.label + ' at $' + context.parsed.y.toFixed(2);
           }
           return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
       }
   }
   ```

IMPORTANT: `renderComparisonEquityCurve()` does NOT need trade markers (comparison mode doesn't show trades). Leave it unchanged.

**Create `pnl_histogram.html`** -- new partial for the P&L distribution bar chart.

```html
<div id="pnl-histogram-section" class="hidden bg-dash-card rounded-lg border border-dash-border p-4">
    <h3 class="text-white font-semibold mb-2">P&L Distribution</h3>
    <div style="position: relative; height: 250px;">
        <canvas id="pnl-histogram-chart"></canvas>
    </div>
</div>
```

Add `<script>` block with `renderPnlHistogram(histogramData)` function:

```javascript
function renderPnlHistogram(histogramData) {
    var section = document.getElementById('pnl-histogram-section');
    if (!histogramData || !histogramData.bins || histogramData.bins.length === 0) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');
    var ctx = document.getElementById('pnl-histogram-chart').getContext('2d');

    if (window._pnlHistChart) { window._pnlHistChart.destroy(); }

    // Color bars green for positive bins, red for negative
    var barColors = histogramData.bins.map(function(bin) {
        // bin is a string like "$-1.23" or "$0.50"
        return parseFloat(bin.replace('$', '')) >= 0 ? '#22c55e' : '#ef4444';
    });

    window._pnlHistChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: histogramData.bins,
            datasets: [{
                label: 'Trade Count',
                data: histogramData.counts,
                backgroundColor: barColors,
                borderColor: barColors.map(function(c) {
                    return c === '#22c55e' ? '#166534' : '#991b1b';
                }),
                borderWidth: 1,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: function(items) { return 'P&L Range: ' + items[0].label; },
                        label: function(context) { return context.parsed.y + ' trade(s)'; }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#6b7280', maxRotation: 45 },
                    grid: { color: '#334155' },
                    title: { display: true, text: 'Net P&L', color: '#9ca3af' }
                },
                y: {
                    ticks: {
                        color: '#6b7280',
                        stepSize: 1,
                        callback: function(v) { return Number.isInteger(v) ? v : ''; }
                    },
                    grid: { color: '#334155' },
                    title: { display: true, text: 'Trade Count', color: '#9ca3af' },
                    beginAtZero: true
                }
            }
        }
    });
}
```

**Modify `backtest.html`:**

1. Add `{% include "partials/pnl_histogram.html" %}` inside `#backtest-results`, AFTER the trade log section and BEFORE the comparison section.

2. Add DOM reference:
   ```javascript
   const pnlHistSection = document.getElementById('pnl-histogram-section');
   ```

3. Update `displaySingleResult(result)` to pass trades to renderEquityCurve and render histogram:
   ```javascript
   // Existing equity curve render -- update to pass trades
   if (result.equity_curve && result.equity_curve.length > 0) {
       equitySection.classList.remove('hidden');
       renderEquityCurve(result.equity_curve, result.config.strategy_mode + ' strategy', '#22c55e', result.trades);
   } else {
       equitySection.classList.add('hidden');
   }

   // Render P&L histogram
   renderPnlHistogram(result.pnl_histogram);
   ```

4. Update `resetResults()` to include:
   ```javascript
   pnlHistSection.classList.add('hidden');
   ```

5. Update `displayComparisonResult` and `displaySweepResult` to hide the histogram:
   ```javascript
   pnlHistSection.classList.add('hidden');
   ```

6. In `displaySweepResult`, the existing `renderEquityCurve` call for best result should NOT pass trades (sweep best result may or may not have trades; pass them if available):
   ```javascript
   var bestTrades = sorted[0].result.trades || [];
   renderEquityCurve(bestEquity, 'Best params', '#22c55e', bestTrades);
   ```

All Chart.js usage follows existing patterns: CDN already loaded, `window._chartName` for destroy/recreate, same dark theme colors, same options structure.
  </action>
  <verify>
    `ls src/bot/dashboard/templates/partials/pnl_histogram.html` -- file exists.
    `grep -c "scatter\|entryPoints\|exitPoints" src/bot/dashboard/templates/partials/equity_curve.html` -- confirms scatter datasets added.
    `grep -c "renderPnlHistogram\|pnl-histogram" src/bot/dashboard/templates/backtest.html` -- confirms histogram wired in.
    `python -c "from bot.dashboard.app import create_dashboard_app; print('app loads OK')"` -- app loads without template errors.
    `python -m pytest tests/ -x --timeout=60` -- no regressions.
  </verify>
  <done>
    Equity curve chart shows green triangle markers at trade entry points and red inverted triangle markers at trade exit points.
    P&L distribution histogram renders as a bar chart with green/red bars for positive/negative bins.
    Both charts handle empty data gracefully (no markers for 0 trades, hidden histogram for empty data).
    Charts properly destroyed and recreated on new backtest runs.
    Histogram and markers hidden in compare/sweep modes.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x --timeout=60` -- full test suite passes
2. Template files exist and contain expected Chart.js code
3. renderEquityCurve accepts trades parameter and builds scatter datasets
4. renderPnlHistogram creates bar chart from pnl_histogram data
5. Dashboard app loads without errors
</verification>

<success_criteria>
- Trade entry markers appear as green upward triangles at correct equity curve positions
- Trade exit markers appear as red downward triangles at correct equity curve positions
- P&L histogram shows bar chart with green (profit) and red (loss) coloring
- Tooltips work for scatter markers and histogram bars
- Empty trade list produces no markers and hidden histogram
- No Chart.js errors in browser console
</success_criteria>

<output>
After completion, create `.planning/phases/09-trade-replay/09-03-SUMMARY.md`
</output>
