---
phase: 09-trade-replay
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/bot/backtest/models.py
  - src/bot/backtest/engine.py
  - src/bot/backtest/sweep.py
  - tests/test_backtest_trades.py
autonomous: true

must_haves:
  truths:
    - "BacktestResult.to_dict() includes a 'trades' list with per-trade entry/exit times, prices, funding, fees, and net P&L"
    - "BacktestResult.to_dict() includes a 'trade_stats' object with win rate, avg win, avg loss, best/worst trade"
    - "BacktestResult.to_dict() includes a 'pnl_histogram' object with bins and counts for trade P&L distribution"
    - "Parameter sweep only retains trades list for the best result; other results have empty trades list but retain trade_stats"
    - "Empty backtests (0 trades) return empty trades list, None-valued trade_stats, and empty histogram"
  artifacts:
    - path: "src/bot/backtest/models.py"
      provides: "BacktestTrade, TradeStats dataclasses with from_position_pnl and from_trades factory methods"
      contains: "class BacktestTrade"
    - path: "src/bot/backtest/models.py"
      provides: "compute_pnl_histogram function for server-side binning"
      contains: "def compute_pnl_histogram"
    - path: "src/bot/backtest/engine.py"
      provides: "Trade extraction from PnLTracker closed positions in _compute_metrics flow"
      contains: "BacktestTrade.from_position_pnl"
    - path: "src/bot/backtest/sweep.py"
      provides: "Memory management for trade lists in parameter sweep"
      contains: "trades=[]"
    - path: "tests/test_backtest_trades.py"
      provides: "TDD tests for BacktestTrade, TradeStats, histogram, and edge cases"
      contains: "def test_"
  key_links:
    - from: "src/bot/backtest/engine.py"
      to: "src/bot/backtest/models.py"
      via: "BacktestTrade.from_position_pnl called on each closed PositionPnL"
      pattern: "BacktestTrade\\.from_position_pnl"
    - from: "src/bot/backtest/models.py"
      to: "src/bot/pnl/tracker.py"
      via: "BacktestTrade extracts data from PositionPnL and FundingPayment"
      pattern: "pnl\\.funding_payments|pnl\\.entry_fee|pnl\\.exit_fee"
    - from: "src/bot/backtest/sweep.py"
      to: "src/bot/backtest/models.py"
      via: "BacktestResult constructed with trades=[] for non-best results"
      pattern: "trades=\\[\\]"
---

<objective>
Create BacktestTrade and TradeStats dataclasses that extract per-trade detail from existing PnLTracker data, integrate them into BacktestResult, and add server-side P&L histogram binning. This provides the complete data layer for trade replay UI (plans 09-02 and 09-03).

Purpose: TRPL-01 (per-trade data), TRPL-03 (win/loss statistics), TRPL-05 (histogram data). All downstream UI plans depend on this data being present in the API response.
Output: Extended BacktestResult with trades, trade_stats, and pnl_histogram fields; sweep memory management updated; TDD tests.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-trade-replay/09-RESEARCH.md
@src/bot/backtest/models.py
@src/bot/backtest/engine.py
@src/bot/backtest/sweep.py
@src/bot/pnl/tracker.py
@src/bot/analytics/metrics.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BacktestTrade, TradeStats, and histogram models with TDD tests</name>
  <files>
    src/bot/backtest/models.py
    tests/test_backtest_trades.py
  </files>
  <action>
**RED phase:** Write tests first in `tests/test_backtest_trades.py`:

1. `test_backtest_trade_from_position_pnl` -- Create a PositionPnL with known values (entry_fee=Decimal("1"), exit_fee=Decimal("0.5"), 3 FundingPayments totaling Decimal("5")), call `BacktestTrade.from_position_pnl(pnl, 1)`, assert all fields: trade_number=1, entry_time_ms = int(opened_at * 1000), exit_time_ms = int(closed_at * 1000), entry_price matches perp_entry_price, exit_price matches perp_exit_price, funding_collected=Decimal("5"), entry_fee=Decimal("1"), exit_fee=Decimal("0.5"), total_fees=Decimal("1.5"), net_pnl=Decimal("3.5"), holding_periods=3, is_win=True.

2. `test_backtest_trade_losing_trade` -- PositionPnL where fees exceed funding (entry_fee=Decimal("3"), exit_fee=Decimal("3"), funding=Decimal("2")), assert net_pnl=Decimal("-4"), is_win=False.

3. `test_backtest_trade_to_dict` -- Call `.to_dict()` on a BacktestTrade, verify all Decimal values are serialized as strings and all fields present.

4. `test_trade_stats_from_trades` -- Build 5 BacktestTrade objects (3 wins, 2 losses with known P&L values), call `TradeStats.from_trades(trades)`, assert: total_trades=5, winning_trades=3, losing_trades=2, win_rate=Decimal("0.6"), avg_win matches mean of winning P&Ls, avg_loss matches mean of losing P&Ls (as POSITIVE value), best_trade=max P&L, worst_trade=min P&L, avg_holding_periods matches mean.

5. `test_trade_stats_empty_trades` -- `TradeStats.from_trades([])` returns total_trades=0, all optional fields None.

6. `test_trade_stats_all_wins` -- All trades are winners, avg_loss is None, losing_trades=0.

7. `test_trade_stats_to_dict` -- Verify Decimal serialization and None handling.

8. `test_compute_pnl_histogram_basic` -- 10 trades with P&Ls ranging -5 to +5, call `compute_pnl_histogram(trades)`, verify bins and counts lists are non-empty, sum of counts equals len(trades).

9. `test_compute_pnl_histogram_empty` -- `compute_pnl_histogram([])` returns `{"bins": [], "counts": []}`.

10. `test_compute_pnl_histogram_same_value` -- All trades have same net_pnl, returns single bin with count=len(trades).

**GREEN phase:** Add to `src/bot/backtest/models.py`:

a) `BacktestTrade` dataclass with fields: trade_number (int), symbol (str), entry_time_ms (int), exit_time_ms (int), entry_price (Decimal), exit_price (Decimal), quantity (Decimal), funding_collected (Decimal), entry_fee (Decimal), exit_fee (Decimal), total_fees (Decimal), net_pnl (Decimal), holding_periods (int), is_win (bool).

Add `@staticmethod from_position_pnl(pnl: PositionPnL, trade_number: int) -> BacktestTrade` -- extract data per research Pattern 1. Use `sum((fp.amount for fp in pnl.funding_payments), Decimal("0"))` for funding. Symbol from `pnl.perp_symbol`.

Add `to_dict()` method serializing all Decimals as str.

b) `TradeStats` dataclass with fields: total_trades (int), winning_trades (int), losing_trades (int), win_rate (Decimal | None), avg_win (Decimal | None), avg_loss (Decimal | None), best_trade (Decimal | None), worst_trade (Decimal | None), avg_holding_periods (Decimal | None).

Add `@staticmethod from_trades(trades: list[BacktestTrade]) -> TradeStats`. Handle empty list (all None). Compute avg_loss as the absolute value of the mean of losing trade P&Ls (so it displays as a positive number representing loss magnitude). Use `Decimal("0.001")` quantize for win_rate (consistent with analytics/metrics.py).

Add `to_dict()` method serializing Decimals as str, None as null.

c) `compute_pnl_histogram(trades: list[BacktestTrade], bin_count: int = 10) -> dict` -- Server-side histogram binning per research Pattern 4. Dynamic bin count: `min(10, max(3, len(trades) // 3))` if bin_count not explicitly provided (use a sentinel or keep the parameter default but apply the formula internally when trades are few). Handle edge cases: empty trades returns `{"bins": [], "counts": []}`, all-same-value returns single bin.

Import `PositionPnL` from `bot.pnl.tracker` (already used in this module's analytics cousin). Add `from __future__ import annotations` if not present to avoid circular import issues -- but check if it's needed first since models.py doesn't currently import from tracker.py.

Run `python -m pytest tests/test_backtest_trades.py -v` -- all tests must pass.
  </action>
  <verify>
    `python -m pytest tests/test_backtest_trades.py -v` -- all 10 tests pass.
    `python -m pytest tests/ -x --timeout=60` -- no regressions.
  </verify>
  <done>BacktestTrade, TradeStats, and compute_pnl_histogram are implemented with full test coverage. All Decimal arithmetic is correct. Edge cases (empty, all-wins, all-same-value) handled.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate trade extraction into BacktestEngine, BacktestResult, and sweep</name>
  <files>
    src/bot/backtest/models.py
    src/bot/backtest/engine.py
    src/bot/backtest/sweep.py
  </files>
  <action>
**Modify `BacktestResult` in `models.py`:**

1. Add `trades: list[BacktestTrade]` field (with `field(default_factory=list)` for backward compatibility).
2. Add `trade_stats: TradeStats | None = None` field.
3. Extend `to_dict()` to include:
   - `"trades": [t.to_dict() for t in self.trades]`
   - `"trade_stats": self.trade_stats.to_dict() if self.trade_stats else None`
   - `"pnl_histogram": compute_pnl_histogram(self.trades)`

**Modify `BacktestEngine._compute_metrics()` in `engine.py`:**

1. Import `BacktestTrade` and `TradeStats` from `bot.backtest.models`.
2. In `_compute_metrics()`, after getting `closed_positions`, build trades list:
   ```python
   trades = [
       BacktestTrade.from_position_pnl(p, i + 1)
       for i, p in enumerate(reversed(closed_positions))  # reversed: oldest first
   ]
   ```
   Note: `get_closed_positions()` returns most-recent-first, so reverse for chronological trade numbering.
3. Compute `trade_stats = TradeStats.from_trades(trades)`.
4. Return trades and trade_stats along with the existing BacktestMetrics. Since `_compute_metrics` currently returns only `BacktestMetrics`, change the return to a tuple or modify the engine to build the full `BacktestResult` with trades. The cleanest approach: have `_compute_metrics` return a tuple `(BacktestMetrics, list[BacktestTrade], TradeStats | None)`, then in `run()` unpack it when constructing BacktestResult.
5. Also fix the `total_trades` in BacktestMetrics: replace the passed-in `total_trades` counter (which counts opens+closes) with `len(closed_positions)` to count round-trip trades correctly (per research Pitfall 1). Update `winning_trades` to use `trade_stats.winning_trades` for consistency.
6. Update `_empty_result()` to include `trades=[]` and `trade_stats=None`.

**Modify `ParameterSweep.run()` in `sweep.py`:**

1. Import `BacktestTrade` and `TradeStats` if not already available via BacktestResult.
2. In the memory management section, when discarding a non-best result's data, also clear its trades list:
   ```python
   BacktestResult(
       config=result.config,
       equity_curve=[],
       trades=[],  # Discard trades to save memory
       trade_stats=result.trade_stats,  # Keep compact stats
       metrics=result.metrics,
   )
   ```
3. Similarly when demoting a previously-best result, clear its trades:
   ```python
   BacktestResult(
       config=results[best_index][1].config,
       equity_curve=[],
       trades=[],  # Discard trades
       trade_stats=results[best_index][1].trade_stats,  # Keep stats
       metrics=results[best_index][1].metrics,
   )
   ```

Run full test suite to verify no regressions. The existing backtest tests should still pass since new fields have defaults.
  </action>
  <verify>
    `python -m pytest tests/ -x --timeout=60` -- all tests pass, no regressions.
    `python -m pytest tests/test_backtest_trades.py tests/test_backtest_engine.py tests/test_backtest_sweep.py -v` -- targeted tests pass.
  </verify>
  <done>
    BacktestResult includes trades, trade_stats, and pnl_histogram in to_dict() output.
    BacktestEngine extracts trades from PnLTracker closed positions.
    Parameter sweep memory management handles trades list (only best retains full list).
    BacktestMetrics.total_trades now counts round-trip trades correctly.
    The API response (via to_dict()) contains all data needed for plans 09-02 and 09-03.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x --timeout=60` -- full test suite passes
2. `python -c "from bot.backtest.models import BacktestTrade, TradeStats, compute_pnl_histogram; print('imports OK')"` -- imports succeed
3. Verify BacktestResult.to_dict() output shape includes trades, trade_stats, pnl_histogram keys
</verification>

<success_criteria>
- BacktestTrade.from_position_pnl correctly extracts all fields from PositionPnL
- TradeStats.from_trades computes correct win rate, avg win/loss, best/worst trade
- compute_pnl_histogram produces valid bins/counts with edge case handling
- BacktestResult.to_dict() includes trades, trade_stats, and pnl_histogram
- Sweep retains trades only for best result
- All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/09-trade-replay/09-01-SUMMARY.md`
</output>
