---
phase: 09-trade-replay
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/bot/dashboard/templates/partials/trade_log.html
  - src/bot/dashboard/templates/partials/trade_stats.html
  - src/bot/dashboard/templates/backtest.html
autonomous: true

must_haves:
  truths:
    - "User can see a trade log table with columns: #, Entry, Exit, Net P&L, Holding Periods, Win/Loss after running a backtest"
    - "User can click a trade row to expand and see full P&L breakdown (funding collected, entry fee, exit fee, total fees, entry/exit prices, quantity)"
    - "User can see a summary stats card showing total trades, winning/losing count, win rate, avg win, avg loss, best trade, worst trade"
    - "Trade log and stats sections are hidden when no trades exist and show a 'No trades' message"
    - "Trade log table appears for single backtest results (not for sweep or compare modes)"
  artifacts:
    - path: "src/bot/dashboard/templates/partials/trade_log.html"
      provides: "Trade log table with expandable rows rendered via JavaScript"
      contains: "trade-log-table"
    - path: "src/bot/dashboard/templates/partials/trade_stats.html"
      provides: "Win/loss summary statistics card"
      contains: "trade-stats-section"
    - path: "src/bot/dashboard/templates/backtest.html"
      provides: "JS functions to render trade log and stats from API response"
      contains: "displayTradeLog"
  key_links:
    - from: "src/bot/dashboard/templates/backtest.html"
      to: "src/bot/dashboard/templates/partials/trade_log.html"
      via: "Jinja2 include and JS function populating innerHTML"
      pattern: "trade-log-body"
    - from: "src/bot/dashboard/templates/backtest.html"
      to: "src/bot/dashboard/templates/partials/trade_stats.html"
      via: "Jinja2 include and JS function populating stats card"
      pattern: "trade-stats"
    - from: "src/bot/dashboard/templates/backtest.html"
      to: "BacktestResult.to_dict() trades and trade_stats fields"
      via: "JS reads result.trades and result.trade_stats from API response"
      pattern: "result\\.trades|result\\.trade_stats"
---

<objective>
Add trade log table and win/loss summary statistics to the backtest page. Users can view every simulated trade with expandable detail rows and see aggregate win/loss statistics at a glance.

Purpose: TRPL-02 (trade log with expandable rows), TRPL-03 (win/loss categorization and summary stats). These are the primary inspection tools for understanding backtest results.
Output: Two new template partials (trade_log.html, trade_stats.html) and updated backtest.html JavaScript.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-trade-replay/09-RESEARCH.md
@.planning/phases/09-trade-replay/09-01-SUMMARY.md
@src/bot/dashboard/templates/backtest.html
@src/bot/dashboard/templates/partials/equity_curve.html
@src/bot/dashboard/templates/partials/param_heatmap.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trade log and trade stats template partials</name>
  <files>
    src/bot/dashboard/templates/partials/trade_log.html
    src/bot/dashboard/templates/partials/trade_stats.html
  </files>
  <action>
**Create `trade_log.html`** -- a new partial for the expandable trade log table.

Structure:
```html
<div id="trade-log-section" class="hidden bg-dash-card rounded-lg border border-dash-border p-4">
    <h3 class="text-white font-semibold mb-3">Trade Log</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="text-gray-400 border-b border-dash-border">
                    <th class="text-left py-2 px-2">#</th>
                    <th class="text-left py-2 px-2">Entry</th>
                    <th class="text-left py-2 px-2">Exit</th>
                    <th class="text-right py-2 px-2">Net P&L</th>
                    <th class="text-right py-2 px-2">Periods</th>
                    <th class="text-left py-2 px-2">Result</th>
                </tr>
            </thead>
            <tbody id="trade-log-body">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
    <p id="trade-log-empty" class="hidden text-gray-500 text-sm text-center py-4">No trades in this backtest.</p>
</div>
```

The table body will be populated by JavaScript in backtest.html. Each trade gets TWO rows:
1. A summary row (clickable) showing trade number, entry/exit dates, net P&L, holding periods, win/loss badge.
2. A hidden detail row (toggled by clicking summary row) showing: funding collected, entry fee, exit fee, total fees, entry price, exit price, quantity, symbol.

Use the existing Tailwind dark theme classes (bg-dash-card, border-dash-border, text-gray-400, etc.) consistent with comparison-table and param_heatmap.html styling.

**Create `trade_stats.html`** -- a new partial for the win/loss summary card.

Structure:
```html
<div id="trade-stats-section" class="hidden">
    <h3 class="text-white font-semibold mb-3">Trade Statistics</h3>
    <div id="trade-stats-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Populated by JS using existing metricCard() pattern -->
    </div>
</div>
```

The JS in backtest.html will populate trade-stats-cards using the existing `metricCard()` function with values from `result.trade_stats`.

Both partials follow the established pattern: HTML containers with IDs, populated by JavaScript, hidden by default, shown when data is available.
  </action>
  <verify>
    Files exist: `ls src/bot/dashboard/templates/partials/trade_log.html src/bot/dashboard/templates/partials/trade_stats.html`
    Both files contain proper HTML structure with the expected IDs.
  </verify>
  <done>trade_log.html partial has table structure with thead and empty tbody#trade-log-body. trade_stats.html partial has grid container for metric cards. Both use consistent Tailwind dark theme styling.</done>
</task>

<task type="auto">
  <name>Task 2: Wire trade log and stats into backtest.html JavaScript</name>
  <files>
    src/bot/dashboard/templates/backtest.html
  </files>
  <action>
**Add partial includes** in backtest.html inside the `#backtest-results` div, AFTER the equity curve section and BEFORE the comparison section:

```html
<!-- Trade Statistics (shown for single backtest) -->
{% include "partials/trade_stats.html" %}

<!-- Trade Log (shown for single backtest) -->
{% include "partials/trade_log.html" %}
```

**Add DOM references** in the IIFE, alongside existing element references:

```javascript
const tradeLogSection = document.getElementById('trade-log-section');
const tradeLogBody = document.getElementById('trade-log-body');
const tradeLogEmpty = document.getElementById('trade-log-empty');
const tradeStatsSection = document.getElementById('trade-stats-section');
const tradeStatsCards = document.getElementById('trade-stats-cards');
```

**Add helper function `fmtDate(ms)`** to format millisecond timestamps as short date+time strings:

```javascript
function fmtDate(ms) {
    var d = new Date(ms);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
           d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}
```

**Add `displayTradeLog(trades)` function:**

1. If `!trades || trades.length === 0`: hide trade-log-section, return.
2. Show trade-log-section.
3. Build HTML for each trade using two-row pattern (per research Pattern 5):
   - Summary row: clickable, with `onclick="this.nextElementSibling.classList.toggle('hidden')"`. Columns: trade_number, fmtDate(entry_time_ms), fmtDate(exit_time_ms), net P&L (green if positive, red if negative using fmtDollar), holding_periods, win/loss text badge.
   - Detail row: hidden by default (`class="hidden"`), colspan=6, containing a grid/flex layout of: Symbol, Entry Price, Exit Price, Quantity, Funding Collected (fmtDollar), Entry Fee (fmtDollar), Exit Fee (fmtDollar), Total Fees (fmtDollar). Use small text and gray colors for detail.
4. Set `tradeLogBody.innerHTML` to the built HTML.
5. If trades.length === 0, show `tradeLogEmpty`, hide table.

**Add `displayTradeStats(tradeStats)` function:**

1. If `!tradeStats || tradeStats.total_trades === 0`: hide trade-stats-section, return.
2. Show trade-stats-section.
3. Build metric cards using existing `metricCard()` function:
   - Total Trades: tradeStats.total_trades (text-white)
   - Win Rate: fmtPercent(tradeStats.win_rate) (text-white)
   - Winning / Losing: `tradeStats.winning_trades + " / " + tradeStats.losing_trades` (text-white)
   - Avg Win: tradeStats.avg_win ? fmtDollar(tradeStats.avg_win) : 'N/A' (text-green-400)
   - Avg Loss: tradeStats.avg_loss ? '-$' + parseFloat(tradeStats.avg_loss).toFixed(2) : 'N/A' (text-red-400) -- Note: avg_loss comes as positive value (magnitude) from server
   - Best Trade: tradeStats.best_trade ? fmtDollar(tradeStats.best_trade) : 'N/A' (text-green-400)
   - Worst Trade: tradeStats.worst_trade ? fmtDollar(tradeStats.worst_trade) : 'N/A' (text-red-400)
   - Avg Holding: tradeStats.avg_holding_periods ? parseFloat(tradeStats.avg_holding_periods).toFixed(1) + ' periods' : 'N/A' (text-white)
4. Set `tradeStatsCards.innerHTML`.

**Update `displaySingleResult(result)` function:**

After the existing code, add calls:
```javascript
displayTradeStats(result.trade_stats);
displayTradeLog(result.trades);
```

**Update `resetResults()` function:**

Add hiding of trade sections:
```javascript
tradeLogSection.classList.add('hidden');
tradeStatsSection.classList.add('hidden');
tradeLogBody.innerHTML = '';
tradeStatsCards.innerHTML = '';
```

**Update `displayComparisonResult` and `displaySweepResult`:** In both functions, ensure trade sections are hidden (they only appear for single backtests):
```javascript
tradeLogSection.classList.add('hidden');
tradeStatsSection.classList.add('hidden');
```

All new JS follows existing patterns: IIFE scoping, `var` for function-level (or `const` matching existing code), string concatenation for HTML building, existing helper functions (metricCard, fmtDollar, fmtPercent, fmtNum).
  </action>
  <verify>
    `python -c "from bot.dashboard.app import create_dashboard_app; print('app loads OK')"` -- app factory loads without template errors.
    Visual check: open backtest page, templates include without errors. (Automated: grep for include directives in backtest.html)
    `grep -c "trade_log\|trade_stats\|displayTradeLog\|displayTradeStats" src/bot/dashboard/templates/backtest.html` -- confirms functions and includes are present.
  </verify>
  <done>
    Backtest page includes trade_log.html and trade_stats.html partials.
    displayTradeLog() renders expandable trade rows from result.trades data.
    displayTradeStats() renders summary metric cards from result.trade_stats data.
    Trade sections hidden for compare/sweep modes, visible for single backtests.
    resetResults() properly clears trade sections.
  </done>
</task>

</tasks>

<verification>
1. Template partials exist and contain expected HTML structure
2. backtest.html includes both partials and has displayTradeLog/displayTradeStats functions
3. `python -m pytest tests/ -x --timeout=60` -- no regressions
4. Dashboard app loads without template errors
</verification>

<success_criteria>
- Trade log table renders with expandable detail rows for each trade
- Trade stats card shows win rate, avg win/loss, best/worst trade using metricCard pattern
- Empty trade list shows "No trades" message
- Trade sections properly hidden in compare and sweep modes
- All styling consistent with existing dashboard dark theme
</success_criteria>

<output>
After completion, create `.planning/phases/09-trade-replay/09-02-SUMMARY.md`
</output>
