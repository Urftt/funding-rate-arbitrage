---
phase: 05-signal-analysis-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bot/signals/basis.py
  - src/bot/signals/volume.py
  - src/bot/market_data/funding_monitor.py
  - tests/test_signals/test_basis.py
  - tests/test_signals/test_volume.py
autonomous: true

must_haves:
  truths:
    - "compute_basis_spread returns (perp_price - spot_price) / spot_price as Decimal"
    - "compute_basis_spread returns Decimal('0') when spot_price is zero"
    - "compute_volume_trend compares recent vs prior period average OHLCV volume and returns a boolean"
    - "Volume filter flags pairs with declining volume (recent < ratio * prior) as volume_ok=False"
    - "FundingMonitor extracts indexPrice from Bybit ticker info dict and stores in TickerService"
    - "Index price stored under derived spot symbol for basis spread computation"
  artifacts:
    - path: "src/bot/signals/basis.py"
      provides: "compute_basis_spread and normalize_basis_score functions"
      exports: ["compute_basis_spread", "normalize_basis_score"]
    - path: "src/bot/signals/volume.py"
      provides: "compute_volume_trend function"
      exports: ["compute_volume_trend"]
    - path: "src/bot/market_data/funding_monitor.py"
      provides: "Index price extraction during poll cycle"
      contains: "indexPrice"
  key_links:
    - from: "src/bot/market_data/funding_monitor.py"
      to: "src/bot/market_data/ticker_service.py"
      via: "update_price with derived spot symbol and index price"
      pattern: "index_price"
    - from: "src/bot/signals/volume.py"
      to: "src/bot/data/models.py"
      via: "accepts list[OHLCVCandle] for volume trend detection"
      pattern: "OHLCVCandle"
---

<objective>
Create the basis spread and volume trend sub-signal modules (SGNL-04, SGNL-05), and extract index price from Bybit tickers for basis computation.

Purpose: Adds the remaining two sub-signals (basis spread and volume filter) and ensures the real-time data pipeline provides spot proxy prices (index price from Bybit perpetual tickers) needed for basis spread computation. Volume uses historical OHLCV candles from Phase 4 to detect declining trends.

Output: `basis.py` and `volume.py` pure computation modules with tests; FundingMonitor enhanced to extract and cache index prices.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-signal-analysis-integration/05-RESEARCH.md
@src/bot/market_data/funding_monitor.py
@src/bot/market_data/ticker_service.py
@src/bot/data/models.py
@src/bot/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Basis spread and volume trend computation modules</name>
  <files>
    src/bot/signals/basis.py
    src/bot/signals/volume.py
    tests/test_signals/test_basis.py
    tests/test_signals/test_volume.py
  </files>
  <action>
**src/bot/signals/basis.py:**

Two public functions:

1. `compute_basis_spread(spot_price: Decimal, perp_price: Decimal) -> Decimal`:
   - Formula: `(perp_price - spot_price) / spot_price`
   - Positive = perp trading at premium (consistent with positive funding rate)
   - Return `Decimal("0")` if `spot_price == Decimal("0")` or `spot_price <= Decimal("0")`
   - Use Decimal throughout (no float)

2. `normalize_basis_score(basis_spread: Decimal, cap: Decimal = Decimal("0.01")) -> Decimal`:
   - Normalize basis to 0-1 range: `min(abs(basis_spread) / cap, Decimal("1"))`
   - We use abs() because both positive and negative basis are informative (magnitude matters for signal strength)
   - Cap prevents extreme basis values from dominating the composite score

**src/bot/signals/volume.py:**

One public function:

1. `compute_volume_trend(candles: list[OHLCVCandle], lookback_days: int = 7, decline_ratio: Decimal = Decimal("0.7")) -> bool`:
   - Import `OHLCVCandle` from `bot.data.models`
   - Split candles into two periods: "recent" (last `lookback_days` worth) and "prior" (the `lookback_days` before that)
   - For 1h OHLCV candles, `lookback_days * 24` candles = one period
   - Compute average volume for each period: `sum(c.volume for c in period) / len(period)`
   - Return `True` (volume OK) if: recent_avg >= decline_ratio * prior_avg
   - Return `True` if insufficient data for both periods (graceful degradation -- don't reject pairs for lack of data)
   - Return `True` if prior_avg is zero (avoid division by zero, treat as no trend data)
   - This is a HARD FILTER per research: volume_ok=False means the pair is rejected regardless of composite score

**tests/test_signals/test_basis.py:**
- Test positive basis spread (perp > spot)
- Test negative basis spread (perp < spot)
- Test zero spot price returns Decimal("0")
- Test negative spot price returns Decimal("0")
- Test normalize_basis_score with small spread (below cap)
- Test normalize_basis_score with large spread (above cap, clamps to 1)
- Test normalize_basis_score with negative spread (uses abs)

**tests/test_signals/test_volume.py:**
- Test volume trend OK (recent volume >= 70% of prior)
- Test volume trend declining (recent < 70% of prior, returns False)
- Test insufficient data for both periods (returns True -- graceful degradation)
- Test sufficient data for recent but not prior (returns True)
- Test all-zero volumes (returns True -- no trend signal)
- Create helper to generate mock OHLCVCandle lists with controllable volumes and timestamps

All test values use Decimal (project convention).
  </action>
  <verify>
Run `python -m pytest tests/test_signals/test_basis.py tests/test_signals/test_volume.py -v` -- all new tests pass.
Run `python -m pytest tests/ -x -q` -- all existing tests also pass.
  </verify>
  <done>
compute_basis_spread computes (perp-spot)/spot safely. normalize_basis_score clamps to 0-1 range. compute_volume_trend detects declining volume trends from OHLCV candles with graceful degradation. All functions tested with edge cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract index price from Bybit tickers for basis spread</name>
  <files>
    src/bot/market_data/funding_monitor.py
  </files>
  <action>
Modify `FundingMonitor._poll_once()` to extract `indexPrice` from the Bybit ticker info dict and store it in TickerService under the derived spot symbol.

**In `_poll_once()`, after the existing volume extraction and before updating `self._funding_rates[symbol]`:**

1. Extract index price:
   ```python
   index_price_raw = info.get("indexPrice")
   ```
   Note: The Bybit v5 API returns `indexPrice` as a string in the `info` dict (the raw Bybit response). This represents the composite spot index price for the perpetual contract. If the field is missing or not parseable, skip silently (no error, no warning -- many tickers may legitimately lack this field).

2. Parse and store:
   ```python
   if index_price_raw is not None:
       try:
           index_price = Decimal(str(index_price_raw))
           if index_price > 0:
               # Derive spot symbol: "BTC/USDT:USDT" -> "BTC/USDT"
               # Use the same derivation pattern as OpportunityRanker
               spot_symbol = symbol.split(":")[0] if ":" in symbol else None
               if spot_symbol:
                   await self._ticker_service.update_price(
                       spot_symbol, index_price, now
                   )
       except (ValueError, ArithmeticError, InvalidOperation):
           pass  # Skip unparseable index prices silently
   ```

3. Add `from decimal import InvalidOperation` to imports (alongside existing `Decimal` import).

4. Also store the index price on the `FundingRateData` in the cache. But wait -- we should NOT modify FundingRateData (it's a v1.0 type). Instead, store index prices in a separate dict on FundingMonitor:
   ```python
   self._index_prices: dict[str, Decimal] = {}  # In __init__
   ```
   And add a getter:
   ```python
   def get_index_price(self, symbol: str) -> Decimal | None:
       """Return the cached index price for a perpetual symbol."""
       return self._index_prices.get(symbol)
   ```
   Store it in `_poll_once()`: `self._index_prices[symbol] = index_price`

This approach:
- Does NOT modify FundingRateData (v1.0 type preserved)
- Stores index price in TickerService under spot symbol (for SignalEngine basis computation)
- Also caches on FundingMonitor for direct access if needed
- Gracefully handles missing/invalid index prices

**Important:** Do NOT add any new test file for this change. The FundingMonitor tests in `tests/test_market_data/` use mocked exchange responses. Adding index price to mocks is straightforward but the key integration test will come in Plan 03 when the SignalEngine actually uses the basis spread.
  </action>
  <verify>
Run `python -m pytest tests/ -x -q` -- all existing tests pass (the change is additive -- missing indexPrice in mocked tickers means index_price_raw is None, which is handled gracefully).
Run `python -c "from bot.market_data.funding_monitor import FundingMonitor; print('OK')"` -- imports cleanly.
  </verify>
  <done>
FundingMonitor extracts indexPrice from Bybit ticker info dict during each poll cycle. Index price stored in TickerService under derived spot symbol AND cached in FundingMonitor._index_prices dict. Missing/invalid index prices handled gracefully. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` -- all tests pass (existing + new)
2. `python -c "from bot.signals.basis import compute_basis_spread, normalize_basis_score; print(compute_basis_spread(Decimal('100'), Decimal('101')))"` -- prints 0.01
3. `python -c "from bot.signals.volume import compute_volume_trend; print('OK')"` -- imports cleanly
4. `grep -n "indexPrice" src/bot/market_data/funding_monitor.py` -- confirms extraction code exists
5. Verify no float usage: `grep -r "float(" src/bot/signals/basis.py src/bot/signals/volume.py` should return nothing
</verification>

<success_criteria>
- basis.py computes and normalizes basis spread with Decimal precision
- volume.py detects declining volume trends from OHLCV candle history
- Both degrade gracefully with insufficient data
- FundingMonitor extracts indexPrice and stores in TickerService under spot symbol
- All new functions tested with edge cases
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/05-signal-analysis-integration/05-02-SUMMARY.md`
</output>
