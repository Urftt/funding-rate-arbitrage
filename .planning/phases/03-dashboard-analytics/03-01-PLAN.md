---
phase: 03-dashboard-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/bot/dashboard/__init__.py
  - src/bot/dashboard/app.py
  - src/bot/dashboard/routes/__init__.py
  - src/bot/dashboard/routes/ws.py
  - src/bot/dashboard/templates/base.html

autonomous: true

must_haves:
  truths:
    - "FastAPI app can be imported and instantiated without errors"
    - "WebSocket hub can accept connections and broadcast HTML fragments"
    - "Base HTML template loads HTMX, Tailwind CSS (CDN), and WebSocket extension"
  artifacts:
    - path: "src/bot/dashboard/app.py"
      provides: "FastAPI app factory with Jinja2 templates and router registration"
      exports: ["create_dashboard_app"]
    - path: "src/bot/dashboard/routes/ws.py"
      provides: "WebSocket hub for real-time HTML fragment broadcast"
      exports: ["DashboardHub", "router"]
    - path: "src/bot/dashboard/templates/base.html"
      provides: "Jinja2 base layout with HTMX, Tailwind CDN, WS connection"
      contains: "hx-ext"
    - path: "pyproject.toml"
      provides: "FastAPI and uvicorn dependencies"
      contains: "fastapi"
  key_links:
    - from: "src/bot/dashboard/app.py"
      to: "src/bot/dashboard/routes/ws.py"
      via: "app.include_router"
      pattern: "include_router.*ws"
    - from: "src/bot/dashboard/templates/base.html"
      to: "htmx CDN"
      via: "script tag"
      pattern: "unpkg.com/htmx"
---

<objective>
Set up the FastAPI dashboard framework: app factory, WebSocket hub for real-time updates, base Jinja2 template with HTMX + Tailwind CDN, and install Python dependencies.

Purpose: Establishes the dashboard skeleton that all subsequent plans build upon. The app factory pattern allows lifespan injection from main.py (Plan 05). The WebSocket hub enables real-time HTML fragment push to all connected clients.

Output: Importable FastAPI app factory, working WebSocket hub class, base HTML template, updated pyproject.toml with dashboard dependencies.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-analytics/03-RESEARCH.md

@src/bot/config.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create FastAPI app factory with WebSocket hub</name>
  <files>
    pyproject.toml
    src/bot/dashboard/__init__.py
    src/bot/dashboard/app.py
    src/bot/dashboard/routes/__init__.py
    src/bot/dashboard/routes/ws.py
  </files>
  <action>
1. Add dashboard dependencies to pyproject.toml:
   - `"fastapi>=0.115"` to main dependencies
   - `"uvicorn[standard]>=0.30"` to main dependencies
   - `"python-multipart>=0.0.9"` to main dependencies (needed for form submissions in DASH-06)

2. Run `uv pip install -e ".[dev]"` to install new dependencies.

3. Create `src/bot/dashboard/__init__.py` (empty).

4. Create `src/bot/dashboard/routes/__init__.py` (empty).

5. Create `src/bot/dashboard/app.py`:
   - `create_dashboard_app(lifespan=None) -> FastAPI` factory function
   - Configure `Jinja2Templates(directory=...)` using `Path(__file__).parent / "templates"` for reliable path resolution
   - Store templates on `app.state.templates`
   - Register a placeholder root route that returns "Dashboard loading..." (pages router added in Plan 04)
   - Import and register ws router: `app.include_router(ws.router)`
   - Add a custom Jinja2 filter `format_decimal` that formats Decimal values to string without `Decimal('...')` wrapper: `lambda v: str(v) if v is not None else "0"`
   - Set FastAPI title to "Funding Rate Arbitrage Dashboard"

6. Create `src/bot/dashboard/routes/ws.py`:
   - `DashboardHub` class with:
     - `self.connections: list[WebSocket] = []`
     - `async def connect(self, ws: WebSocket)` — accept and append
     - `def disconnect(self, ws: WebSocket)` — remove if present
     - `async def broadcast(self, html: str)` — iterate connections copy, send_text, remove on error
   - `router = APIRouter()` with a single WebSocket endpoint at `/ws`:
     - Get hub from `websocket.app.state.hub`
     - Call `hub.connect(websocket)`
     - Enter receive loop (just consume messages to keep connection alive)
     - On WebSocketDisconnect, call `hub.disconnect(websocket)`
   - Instantiate a global `hub = DashboardHub()` that gets stored on app.state in the app factory

Note: Do NOT use sse-starlette. Use WebSocket for bidirectional communication (needed for DASH-04 start/stop and DASH-06 config updates).
  </action>
  <verify>
Run: `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && python -c "from bot.dashboard.app import create_dashboard_app; app = create_dashboard_app(); print('OK:', app.title)"`
Must print: "OK: Funding Rate Arbitrage Dashboard"

Run: `python -c "from bot.dashboard.routes.ws import DashboardHub; hub = DashboardHub(); print('Hub OK, connections:', len(hub.connections))"`
Must print: "Hub OK, connections: 0"
  </verify>
  <done>
FastAPI app factory importable and instantiable. WebSocket hub class works. New pip dependencies installed. All dashboard package __init__.py files exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create base HTML template with HTMX, Tailwind CSS, and WebSocket connection</name>
  <files>
    src/bot/dashboard/templates/base.html
  </files>
  <action>
Create `src/bot/dashboard/templates/base.html` as the Jinja2 base layout template:

1. HTML5 doctype with `<html lang="en" class="dark">` (dark theme default per research recommendation)
2. `<head>`:
   - Meta charset UTF-8, viewport for responsive
   - `<title>{% block title %}Funding Rate Arbitrage{% endblock %}</title>`
   - Script: `https://unpkg.com/htmx.org@2.0.4` (HTMX core)
   - Script: `https://unpkg.com/htmx-ext-ws@2.0.4/ws.js` (WebSocket extension)
   - Script: `https://cdn.tailwindcss.com` (Tailwind CSS CDN)
   - Tailwind config script block to enable dark mode and set a dark trading-dashboard color scheme:
     ```
     tailwind.config = { darkMode: 'class', theme: { extend: { colors: { 'dash-bg': '#0f172a', 'dash-card': '#1e293b', 'dash-border': '#334155' } } } }
     ```
   - `{% block head %}{% endblock %}` for child template additions

3. `<body>` with dark theme classes: `class="bg-dash-bg text-gray-200 min-h-screen"` and `hx-ext="ws" ws-connect="/ws"`:
   - Sticky header/nav bar with:
     - "Funding Rate Arbitrage" title (left)
     - `<div id="bot-status-badge">` placeholder for bot status badge (right)
   - Main content area: `<main class="container mx-auto px-4 py-6">{% block content %}{% endblock %}</main>`
   - `{% block scripts %}{% endblock %}` before closing body

4. Style the nav with Tailwind: `bg-dash-card border-b border-dash-border px-6 py-3 flex items-center justify-between`

5. Add a small footer: `<footer class="text-center text-gray-500 text-xs py-4">Dashboard v1.0 | Data refreshes every 5s</footer>`

Do NOT include any partials/includes yet -- those are created in Plan 04. The base template provides the shell that child templates extend.
  </action>
  <verify>
Run: `python -c "
from pathlib import Path
p = Path('src/bot/dashboard/templates/base.html')
content = p.read_text()
assert 'htmx.org' in content, 'Missing HTMX'
assert 'tailwindcss' in content, 'Missing Tailwind'
assert 'ws-connect' in content, 'Missing WS connect'
assert 'block content' in content, 'Missing content block'
print('base.html OK')
"` from repo root.
  </verify>
  <done>
Base HTML template exists with HTMX 2.0.4, HTMX WS extension 2.0.4, Tailwind CSS CDN, dark theme, responsive layout, WebSocket connection to /ws, and Jinja2 block structure for child templates.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from bot.dashboard.app import create_dashboard_app"` succeeds
2. `python -c "from bot.dashboard.routes.ws import DashboardHub"` succeeds
3. `pip show fastapi uvicorn python-multipart` shows all installed
4. `base.html` contains HTMX, Tailwind CDN, WS connection, dark theme
5. No import errors in any new module
</verification>

<success_criteria>
- FastAPI app factory creates a valid FastAPI application with Jinja2 templates
- WebSocket hub manages connections and can broadcast (tested via import)
- Base template has all CDN dependencies and dark theme styling
- pyproject.toml updated with fastapi, uvicorn, python-multipart
- All new files follow existing codebase patterns (docstrings, structlog, type hints)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-analytics/03-01-SUMMARY.md`
</output>
