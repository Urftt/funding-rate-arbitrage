---
phase: 03-dashboard-analytics
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/bot/dashboard/routes/pages.py
  - src/bot/dashboard/routes/api.py
  - src/bot/dashboard/routes/actions.py
  - src/bot/dashboard/templates/index.html
  - src/bot/dashboard/templates/partials/positions.html
  - src/bot/dashboard/templates/partials/funding_rates.html
  - src/bot/dashboard/templates/partials/trade_history.html
  - src/bot/dashboard/templates/partials/bot_status.html
  - src/bot/dashboard/templates/partials/balance.html
  - src/bot/dashboard/templates/partials/config_form.html
  - src/bot/dashboard/templates/partials/analytics.html
  - src/bot/dashboard/app.py

autonomous: true

must_haves:
  truths:
    - "User can view open positions with pair, entry price, size, P&L, and funding collected (DASH-01)"
    - "User can see funding rate overview across all perpetual pairs (DASH-02)"
    - "User can view trade history with timestamps, realized P&L, and cumulative profit (DASH-03)"
    - "User can start/stop bot and see current status and error alerts (DASH-04)"
    - "User can see balance breakdown: available vs allocated capital (DASH-05)"
    - "User can configure strategy parameters via dashboard form (DASH-06)"
    - "User can view performance analytics: Sharpe ratio, max drawdown, win rate (DASH-07)"
  artifacts:
    - path: "src/bot/dashboard/routes/pages.py"
      provides: "Main page route serving index.html with all dashboard data"
      exports: ["router"]
    - path: "src/bot/dashboard/routes/api.py"
      provides: "JSON API endpoints for positions, funding rates, trade history, analytics"
      exports: ["router"]
    - path: "src/bot/dashboard/routes/actions.py"
      provides: "POST endpoints for bot start/stop and config update"
      exports: ["router"]
    - path: "src/bot/dashboard/templates/index.html"
      provides: "Main dashboard page extending base.html with all panels"
      contains: "extends"
    - path: "src/bot/dashboard/templates/partials/positions.html"
      provides: "HTMX-swappable positions table"
      contains: "id=\"positions-panel\""
  key_links:
    - from: "src/bot/dashboard/routes/pages.py"
      to: "src/bot/dashboard/templates/index.html"
      via: "TemplateResponse"
      pattern: "TemplateResponse.*index"
    - from: "src/bot/dashboard/routes/actions.py"
      to: "src/bot/orchestrator.py"
      via: "request.app.state.orchestrator"
      pattern: "orchestrator\\.stop|orchestrator\\.restart"
    - from: "src/bot/dashboard/routes/actions.py"
      to: "src/bot/config.py RuntimeConfig"
      via: "request.app.state.orchestrator.runtime_config"
      pattern: "RuntimeConfig"
---

<objective>
Build all dashboard routes (pages, API, actions) and Jinja2 templates covering all seven DASH requirements. Register routes in app factory. Implement the periodic WebSocket update loop.

Purpose: This is the user-facing layer. Every DASH requirement gets a visible panel on the dashboard with real-time updates via WebSocket.

Output: Complete dashboard UI with routes, templates, and real-time updates.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-analytics/03-RESEARCH.md

@src/bot/dashboard/app.py
@src/bot/dashboard/routes/ws.py
@src/bot/config.py
@src/bot/pnl/tracker.py
@src/bot/orchestrator.py
@src/bot/models.py
@src/bot/analytics/metrics.py

# Prior plan summaries needed for integration
@.planning/phases/03-dashboard-analytics/03-01-SUMMARY.md
@.planning/phases/03-dashboard-analytics/03-02-SUMMARY.md
@.planning/phases/03-dashboard-analytics/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create page routes, API routes, and action routes</name>
  <files>
    src/bot/dashboard/routes/pages.py
    src/bot/dashboard/routes/api.py
    src/bot/dashboard/routes/actions.py
    src/bot/dashboard/app.py
  </files>
  <action>
**pages.py:**
- `router = APIRouter()`
- `GET /` — Main dashboard page. Gathers all data from app.state components and renders `index.html`:
  - `orchestrator = request.app.state.orchestrator`
  - `status = orchestrator.get_status()`
  - `positions = request.app.state.position_manager.get_open_positions()`
  - `pnl_tracker = request.app.state.pnl_tracker`
  - For each position, call `pnl_tracker.get_total_pnl(pos.id)` to get P&L breakdown
  - `funding_rates = request.app.state.funding_monitor.get_all_funding_rates()[:50]` (top 50 by rate)
  - `closed = pnl_tracker.get_closed_positions()[:50]` (last 50 trades)
  - `portfolio = pnl_tracker.get_portfolio_summary()`
  - `analytics_data = {}` with sharpe, drawdown, win_rate from `bot.analytics.metrics` using `pnl_tracker.get_all_position_pnls()` filtered to closed
  - Current settings for config form: `request.app.state.orchestrator._settings`
  - Return `TemplateResponse("index.html", {all context vars})`

**api.py:**
- `router = APIRouter()`
- `GET /api/positions` — JSON list of open positions with P&L (DASH-01)
- `GET /api/funding-rates` — JSON list of all funding rates (DASH-02)
- `GET /api/trade-history` — JSON list of closed positions (DASH-03)
- `GET /api/status` — JSON bot status (DASH-04)
- `GET /api/balance` — JSON portfolio summary (DASH-05)
- `GET /api/analytics` — JSON analytics (DASH-07)
- All endpoints read from `request.app.state.*` components
- All Decimal values serialized as strings in JSON responses
- Use Pydantic response models or simple dicts (dicts are fine for v1)

**actions.py:**
- `router = APIRouter()`
- `POST /actions/bot/stop` — Call `orchestrator.stop()`, return updated bot_status.html partial
- `POST /actions/bot/start` — Call `orchestrator.restart()`, return updated bot_status.html partial
- `POST /actions/config` — Parse form data into RuntimeConfig, set on orchestrator, return updated config_form.html partial with success message
  - Accept form fields: min_funding_rate, max_position_size_usd, exit_funding_rate, max_simultaneous_positions, max_position_size_per_pair, min_volume_24h, scan_interval
  - Only set non-empty fields on RuntimeConfig
  - Convert string values to Decimal/int as appropriate
  - Wrap in try/except for validation errors, return error message in partial

**app.py update:**
- Import and register the three new routers:
  ```python
  from bot.dashboard.routes import pages, api, actions
  app.include_router(pages.router)
  app.include_router(api.router, prefix="/api")
  app.include_router(actions.router, prefix="/actions")
  ```
- Remove the placeholder root route (pages.py now handles GET /)

All route handlers must be `async def`. Use structlog logger for error logging in action routes.
  </action>
  <verify>
Run from repo root:
```
python -c "
from bot.dashboard.app import create_dashboard_app
app = create_dashboard_app()
routes = [r.path for r in app.routes]
assert '/' in routes or any('/' == r.path for r in app.routes), 'Missing root route'
print('Routes registered:', len(routes))
print('Routes:', sorted(set(r.path for r in app.routes if hasattr(r, 'path'))))
"
```
Must show routes including /, /api/positions, /api/funding-rates, /actions/bot/stop, /actions/bot/start, /actions/config, /ws.
  </verify>
  <done>
All dashboard routes created: page route serves full dashboard, API routes return JSON, action routes handle bot control and config updates. All routes registered in app factory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create all Jinja2 templates (index page + 7 partials) and WebSocket update loop</name>
  <files>
    src/bot/dashboard/templates/index.html
    src/bot/dashboard/templates/partials/positions.html
    src/bot/dashboard/templates/partials/funding_rates.html
    src/bot/dashboard/templates/partials/trade_history.html
    src/bot/dashboard/templates/partials/bot_status.html
    src/bot/dashboard/templates/partials/balance.html
    src/bot/dashboard/templates/partials/config_form.html
    src/bot/dashboard/templates/partials/analytics.html
  </files>
  <action>
Create `src/bot/dashboard/templates/partials/` directory.

**index.html** — extends base.html:
```
{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
  <!-- Top row: Status + Balance + Analytics summary -->
  <div>{% include "partials/bot_status.html" %}</div>
  <div>{% include "partials/balance.html" %}</div>
  <div>{% include "partials/analytics.html" %}</div>
</div>

<!-- Positions table -->
<div class="mt-4">{% include "partials/positions.html" %}</div>

<!-- Two-column: Funding rates + Trade history -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
  <div>{% include "partials/funding_rates.html" %}</div>
  <div>{% include "partials/trade_history.html" %}</div>
</div>

<!-- Config form -->
<div class="mt-4">{% include "partials/config_form.html" %}</div>
{% endblock %}
```

**Each partial** must have an outer `<div id="xxx-panel">` wrapper so HTMX WebSocket OOB swaps can target it. Use `hx-swap-oob="innerHTML:#xxx-panel"` in WebSocket-pushed fragments.

**partials/bot_status.html** (DASH-04):
- Card with dark bg (`bg-dash-card rounded-lg p-4 border border-dash-border`)
- Title: "Bot Status"
- Show: running/stopped badge (green/red), mode (paper/live), open positions count
- Emergency status indicator (red warning if triggered)
- Two buttons: "Stop Bot" (`hx-post="/actions/bot/stop" hx-target="#bot-status-panel" hx-swap="innerHTML"`) and "Start Bot" (`hx-post="/actions/bot/start" hx-target="#bot-status-panel" hx-swap="innerHTML"`)
- Show only relevant button (stop if running, start if stopped)
- Error alerts section: if emergency_triggered, show red alert banner

**partials/balance.html** (DASH-05):
- Card showing: Net P&L, Total Funding Collected, Total Fees Paid, Position Count
- Use `{{ value | format_decimal }}` filter for Decimal values
- Color code: green for positive P&L, red for negative

**partials/analytics.html** (DASH-07):
- Card showing: Sharpe Ratio, Max Drawdown, Win Rate
- Handle None values: show "Insufficient data" in gray text
- Format Sharpe to 2 decimal places, drawdown as USD, win rate as percentage

**partials/positions.html** (DASH-01):
- Table with columns: Pair, Entry Price (Spot/Perp), Size, Unrealized P&L, Funding Collected, Net P&L
- Dark table styling with alternating row shading
- Color code P&L columns (green positive, red negative)
- Empty state: "No open positions" message

**partials/funding_rates.html** (DASH-02):
- Table with columns: Symbol, Funding Rate, Volume 24h, Next Funding, Interval
- Show top 30 pairs sorted by rate descending
- Format rate as percentage (multiply by 100, show 4 decimals)
- Highlight rates above min_funding_rate threshold in green

**partials/trade_history.html** (DASH-03):
- Table with columns: Pair, Opened, Closed, Funding Collected, Fees, Net P&L
- Show last 50 closed positions
- Format timestamps as human-readable (use Jinja2 custom filter or inline JS)
- Running cumulative profit in last column or as a summary row at bottom

**partials/config_form.html** (DASH-06):
- Card with form fields for each configurable parameter:
  - Min Funding Rate (number input, step 0.0001)
  - Max Position Size USD (number input)
  - Exit Funding Rate (number input, step 0.0001)
  - Max Simultaneous Positions (integer input)
  - Max Position Size Per Pair (number input)
  - Min Volume 24h (number input)
  - Scan Interval seconds (integer input)
- Pre-populate with current settings values
- Submit button: `hx-post="/actions/config" hx-target="#config-form-panel" hx-swap="innerHTML"`
- Show success/error message after submission
- Label each field with current value as placeholder

**WebSocket update function** — Add to `app.py` or a new `src/bot/dashboard/update_loop.py`:
- `async def dashboard_update_loop(app: FastAPI)` function that:
  1. Sleeps for `update_interval` seconds (from DashboardSettings or app.state)
  2. Gets hub from `app.state.hub`
  3. Gets templates from `app.state.templates`
  4. Renders each partial with current data from app.state components
  5. Wraps each rendered partial in OOB swap div: `<div id="xxx-panel" hx-swap-oob="true">...content...</div>`
  6. Broadcasts all partials as a single concatenated HTML string
  7. Loops until app shutdown
  8. Handles exceptions gracefully (log and continue)
- This function will be started as an asyncio task in the lifespan (Plan 05), but define it here
- Store it as `dashboard_update_loop` export from the dashboard package
  </action>
  <verify>
Run from repo root:
```
python -c "
from pathlib import Path
templates_dir = Path('src/bot/dashboard/templates')
required = ['index.html', 'partials/positions.html', 'partials/funding_rates.html',
            'partials/trade_history.html', 'partials/bot_status.html',
            'partials/balance.html', 'partials/config_form.html', 'partials/analytics.html']
for t in required:
    p = templates_dir / t
    assert p.exists(), f'Missing template: {t}'
    content = p.read_text()
    assert len(content) > 50, f'Template too small: {t}'
print('All templates OK:', len(required), 'templates')
"
```
  </verify>
  <done>
All 8 templates created (1 index + 7 partials). Each partial has unique ID for OOB swaps. Dashboard update loop function defined for periodic WebSocket push. All DASH-01 through DASH-07 requirements have corresponding UI panels.
  </done>
</task>

</tasks>

<verification>
1. All 8 templates exist and contain meaningful HTML
2. All route modules import without errors
3. App factory registers all routes (pages, api, actions, ws)
4. Each partial has a unique ID attribute for OOB swaps
5. Templates use `format_decimal` filter for Decimal values
6. Action routes reference orchestrator.stop(), orchestrator.restart(), RuntimeConfig
</verification>

<success_criteria>
- GET / returns a full dashboard page with all 7 panels
- GET /api/* endpoints return JSON data for each DASH requirement
- POST /actions/bot/stop and /actions/bot/start control the orchestrator
- POST /actions/config updates RuntimeConfig
- All templates use dark theme, Tailwind classes, and HTMX attributes
- WebSocket update loop function is defined and ready for integration
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-analytics/03-04-SUMMARY.md`
</output>
