---
phase: 03-dashboard-analytics
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/bot/analytics/__init__.py
  - src/bot/analytics/metrics.py
  - tests/test_analytics.py

autonomous: true

must_haves:
  truths:
    - "Sharpe ratio computed correctly from closed position returns with Decimal precision"
    - "Max drawdown computed as deepest peak-to-trough decline in cumulative P&L"
    - "Win rate computed per pair and overall from closed position net P&L"
    - "All analytics return None or informative defaults with insufficient data"
  artifacts:
    - path: "src/bot/analytics/metrics.py"
      provides: "Pure Decimal analytics: sharpe_ratio, max_drawdown, win_rate, win_rate_by_pair"
      exports: ["sharpe_ratio", "max_drawdown", "win_rate", "win_rate_by_pair"]
    - path: "tests/test_analytics.py"
      provides: "TDD tests covering normal, edge, and insufficient-data cases"
      contains: "test_sharpe"
  key_links:
    - from: "src/bot/analytics/metrics.py"
      to: "src/bot/pnl/tracker.py"
      via: "PositionPnL dataclass as input type"
      pattern: "PositionPnL"
---

<objective>
Implement performance analytics calculations (DASH-07) using TDD: Sharpe ratio, max drawdown, win rate overall, and win rate by pair. All math uses Decimal for precision.

Purpose: DASH-07 requires the user to see performance analytics. These are pure computation functions with well-defined inputs and outputs -- ideal for TDD. The functions operate on `PositionPnL` records from `PnLTracker`.

Output: Tested `analytics/metrics.py` module with all four analytics functions.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-analytics/03-RESEARCH.md

@src/bot/pnl/tracker.py
</context>

<feature>
  <name>Performance Analytics (DASH-07)</name>
  <files>src/bot/analytics/metrics.py, tests/test_analytics.py</files>
  <behavior>
All functions accept `list[PositionPnL]` (closed positions with funding payments and fees).

**sharpe_ratio(positions, risk_free_rate=0, annualization_factor=1095) -> Decimal | None**
- Calculate net return per position: sum(funding_payments.amount) - entry_fee - exit_fee
- Mean return = sum(returns) / N
- Std dev = sample standard deviation (N-1 denominator)
- Sharpe = ((mean - risk_free) / std_dev) * sqrt(annualization)
- annualization_factor: 1095 = 3 funding periods/day * 365 days
- Return None if < 2 positions or std_dev == 0

Cases:
- 3 positions with known returns [10, 5, 15] -> verifiable Sharpe
- 1 position -> None (insufficient data)
- All identical returns -> None (zero std dev)
- Empty list -> None

**max_drawdown(positions) -> Decimal | None**
- Sort closed positions by closed_at timestamp
- Compute cumulative P&L series (running sum of net returns)
- Track running peak and max drawdown = max(peak - current) across series
- Return as positive Decimal (e.g., Decimal("5.50") means $5.50 drawdown)
- Return None if no closed positions

Cases:
- Sequence: +10, -5, +3 -> cumulative [10, 5, 8] -> peak 10, trough 5, drawdown 5
- All profitable -> drawdown is 0
- Empty -> None
- Single position with loss -> drawdown equals the loss

**win_rate(positions) -> Decimal | None**
- A "win" is a closed position where net return > 0 (funding - fees > 0)
- Return wins / total as Decimal (e.g., 0.667 for 2/3)
- Return None if no closed positions

Cases:
- 2 wins, 1 loss -> Decimal("0.667") (rounded to 3 places)
- All wins -> Decimal("1.000")
- All losses -> Decimal("0.000")
- Empty -> None

**win_rate_by_pair(positions) -> dict[str, Decimal]**
- Group by perp_symbol, compute win_rate per group
- Return dict mapping perp_symbol -> win_rate
- Exclude pairs with zero positions

Cases:
- BTC: 2 wins, 1 loss; ETH: 1 win, 0 loss -> {"BTC/USDT:USDT": 0.667, "ETH/USDT:USDT": 1.000}
- Empty -> {}
  </behavior>
  <implementation>
Create `src/bot/analytics/__init__.py` (empty).

Implement all four functions in `src/bot/analytics/metrics.py`:
- Import `Decimal` from decimal, `PositionPnL` and `FundingPayment` from `bot.pnl.tracker`
- All Decimal arithmetic, no float conversions
- Use `Decimal.sqrt()` for square root (available on Decimal)
- Guard all functions against insufficient data (return None)
- Round win_rate to 3 decimal places using `quantize(Decimal("0.001"))`
- For max_drawdown, if all positions are profitable (no drawdown), return Decimal("0")
- Use ROUND_HALF_UP for quantize operations

Helper function `_net_return(position: PositionPnL) -> Decimal`:
- `sum(fp.amount for fp in position.funding_payments, Decimal("0")) - position.entry_fee - position.exit_fee`
  </implementation>
</feature>

<verification>
`cd /Users/luckleineschaars/repos/funding-rate-arbitrage && python -m pytest tests/test_analytics.py -v`
All tests pass. No regressions in existing tests: `python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- All four analytics functions implemented with Decimal precision
- Comprehensive test coverage including edge cases and insufficient-data guards
- TDD cycle completed: RED (failing tests) -> GREEN (implementation) -> tests pass
- No external analytics dependencies (no pandas, numpy, quantstats)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-analytics/03-03-SUMMARY.md`
</output>
