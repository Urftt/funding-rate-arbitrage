---
phase: 11-decision-context
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/bot/dashboard/templates/partials/funding_rates.html
  - src/bot/dashboard/templates/partials/signal_breakdown.html
  - src/bot/dashboard/templates/decision.html
  - src/bot/dashboard/templates/base.html
  - src/bot/dashboard/update_loop.py
  - src/bot/dashboard/routes/pages.py
autonomous: true

must_haves:
  truths:
    - "User can see percentile badge and trend arrow next to each funding rate on the main dashboard"
    - "User can see action label (Strong opportunity, Below average, etc.) for each pair on the funding rates panel"
    - "User can see signal score breakdown showing sub-signal contributions on the decision summary page"
    - "User can hover over key metrics to see glossary tooltip explanations"
    - "User can navigate to /decision summary page from the nav bar"
    - "User can view a should-I-trade summary page aggregating all pairs with decision contexts"
    - "Funding rates panel updates in real-time with decision context via WebSocket"
  artifacts:
    - path: "src/bot/dashboard/templates/partials/funding_rates.html"
      provides: "Enhanced funding rates panel with percentile badge, trend arrow, and action label columns"
      contains: "percentile"
    - path: "src/bot/dashboard/templates/partials/signal_breakdown.html"
      provides: "Signal score breakdown partial with bar chart visualization"
      contains: "signal_breakdown"
    - path: "src/bot/dashboard/templates/decision.html"
      provides: "Decision summary page with glossary tooltips and per-pair recommendation cards"
      contains: "decision_contexts"
    - path: "src/bot/dashboard/templates/base.html"
      provides: "Navigation link to /decision page"
      contains: "/decision"
    - path: "src/bot/dashboard/update_loop.py"
      provides: "Decision contexts passed to funding_rates.html render in WebSocket loop"
      contains: "decision_contexts"
    - path: "src/bot/dashboard/routes/pages.py"
      provides: "GET /decision page route"
      contains: "decision_page"
  key_links:
    - from: "src/bot/dashboard/update_loop.py"
      to: "src/bot/analytics/decision_engine.py"
      via: "app.state.decision_engine.get_all_decision_contexts()"
      pattern: "decision_engine.*get_all_decision_contexts"
    - from: "src/bot/dashboard/templates/partials/funding_rates.html"
      to: "decision_contexts dict"
      via: "Jinja2 template variable passed from update loop"
      pattern: "decision_contexts"
    - from: "src/bot/dashboard/routes/pages.py"
      to: "src/bot/analytics/decision_engine.py"
      via: "app.state.decision_engine for decision summary page data"
      pattern: "decision_engine"
    - from: "src/bot/dashboard/templates/decision.html"
      to: "/api/decision/summary"
      via: "fetch() call on page load for dynamic data"
      pattern: "fetch.*api/decision"
---

<objective>
Build the frontend presentation layer for decision context: enhanced funding rates panel with percentile badges, trend arrows, and action labels; signal breakdown display; glossary tooltips; and a dedicated "Should I Trade?" summary page.

Purpose: This transforms raw backend data into actionable visual recommendations. Users see at a glance whether a pair is worth trading, with historical evidence supporting each recommendation.

Output: Enhanced funding rates panel, signal breakdown partial, decision summary page, glossary tooltips, nav link, and WebSocket update loop integration.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-decision-context/11-RESEARCH.md
@.planning/phases/11-decision-context/11-01-SUMMARY.md
@src/bot/dashboard/templates/partials/funding_rates.html
@src/bot/dashboard/templates/base.html
@src/bot/dashboard/update_loop.py
@src/bot/dashboard/routes/pages.py
@src/bot/dashboard/templates/pairs.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced funding rates panel with decision context and WebSocket update loop integration</name>
  <files>
    src/bot/dashboard/templates/partials/funding_rates.html
    src/bot/dashboard/update_loop.py
    src/bot/dashboard/routes/pages.py
  </files>
  <action>
**Modify `src/bot/dashboard/templates/partials/funding_rates.html`:**

Add 3 new columns to the funding rates table: Percentile, Trend, and Action.

In the `<thead>`, add after the "Interval" column:
- `<th class="text-right py-2 px-2">Pctl</th>` -- short for percentile
- `<th class="text-center py-2 px-2">Trend</th>`
- `<th class="text-right py-2 px-2">Action</th>`

In each `<tr>` row, after the interval `<td>`, add:

1. **Percentile badge**: Look up `decision_contexts` dict by `fr.symbol`. If available and has rate_context.percentile:
   ```html
   <td class="py-1.5 px-2 text-right">
     {% set ctx = decision_contexts.get(fr.symbol) if decision_contexts is defined else none %}
     {% if ctx and ctx.rate_context %}
       {% set p = ctx.rate_context.percentile | int %}
       <span class="text-xs px-1.5 py-0.5 rounded
         {% if p >= 75 %}bg-blue-500/20 text-blue-300
         {% elif p >= 50 %}bg-cyan-500/20 text-cyan-300
         {% elif p >= 25 %}bg-amber-500/20 text-amber-300
         {% else %}bg-gray-500/20 text-gray-400{% endif %}">
         P{{ p }}
       </span>
     {% endif %}
   </td>
   ```
   Use blue-tone palette for decision context (NOT green/red which is reserved for rate values per research anti-pattern guidance).

2. **Trend arrow**: Display Unicode arrows with semantic colors (green for rising is OK here since it matches meaning):
   ```html
   <td class="py-1.5 px-2 text-center">
     {% if ctx and ctx.rate_context %}
       {% if ctx.rate_context.trend.value == 'rising' %}
         <span class="text-green-400 text-xs" title="Rising">&#9650;</span>
       {% elif ctx.rate_context.trend.value == 'falling' %}
         <span class="text-red-400 text-xs" title="Falling">&#9660;</span>
       {% else %}
         <span class="text-gray-500 text-xs" title="Stable">&#9644;</span>
       {% endif %}
     {% endif %}
   </td>
   ```

3. **Action label**: Color-coded badge using distinct palette:
   ```html
   <td class="py-1.5 px-2 text-right">
     {% if ctx and ctx.action %}
       <span class="text-xs px-1.5 py-0.5 rounded whitespace-nowrap
         {% if ctx.action.label == 'Strong opportunity' %}bg-blue-500/20 text-blue-300
         {% elif ctx.action.label == 'Moderate opportunity' %}bg-cyan-500/20 text-cyan-300
         {% elif ctx.action.label == 'Below average' %}bg-amber-500/20 text-amber-300
         {% elif ctx.action.label == 'Insufficient data' %}bg-gray-500/20 text-gray-400
         {% else %}bg-red-500/20 text-red-300{% endif %}">
         {{ ctx.action.label }}
       </span>
     {% endif %}
   </td>
   ```

The template expects a `decision_contexts` variable (dict mapping symbol -> DecisionContext). If not provided, the new columns render empty (graceful degradation).

**Modify `src/bot/dashboard/update_loop.py`:**

In the main loop, after gathering `funding_rates`, add decision context computation:

```python
# Decision contexts for enhanced funding rates panel (Phase 11)
decision_engine = getattr(app.state, "decision_engine", None)
decision_contexts = {}
if decision_engine is not None:
    try:
        decision_contexts = await decision_engine.get_all_decision_contexts()
    except Exception:
        log.debug("decision_contexts_unavailable", exc_info=True)
```

Update the funding rates template render call to pass `decision_contexts`:
```python
tpl = env.get_template("partials/funding_rates.html")
html = tpl.render(funding_rates=funding_rates, decision_contexts=decision_contexts)
```

**Modify `src/bot/dashboard/routes/pages.py`:**

In the `dashboard_index` function, add decision context gathering before the context dict:

```python
# Decision contexts for enhanced funding rates panel (Phase 11)
decision_engine = getattr(request.app.state, "decision_engine", None)
decision_contexts = {}
if decision_engine is not None:
    try:
        decision_contexts = await decision_engine.get_all_decision_contexts()
    except Exception:
        decision_contexts = {}
```

Add `"decision_contexts": decision_contexts` to the template context dict passed to `index.html`.

Also update the initial funding_rates partial render within index.html -- since index.html includes the partial via `{% include %}`, the variable will be available in scope automatically.
  </action>
  <verify>
Run `python -c "from bot.dashboard.update_loop import dashboard_update_loop; print('update_loop imports OK')"` from src directory.

Run `python -c "from bot.dashboard.routes.pages import router; print('pages imports OK')"` from src directory.

Verify the funding_rates.html template parses: `python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('src/bot/dashboard/templates')); t = env.get_template('partials/funding_rates.html'); print('template OK')"`.

Run `python -m pytest tests/ -x -q 2>&1 | tail -5` to verify no regressions.
  </verify>
  <done>
Funding rates panel shows 3 new columns (Percentile badge, Trend arrow, Action label) for each pair with decision context data. WebSocket update loop passes decision_contexts to the template for real-time updates. Dashboard index page also passes decision_contexts on initial load. Empty columns render gracefully when decision engine unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Decision summary page with signal breakdown, glossary tooltips, and navigation</name>
  <files>
    src/bot/dashboard/templates/decision.html
    src/bot/dashboard/templates/partials/signal_breakdown.html
    src/bot/dashboard/templates/base.html
    src/bot/dashboard/routes/pages.py
  </files>
  <action>
**Create `src/bot/dashboard/templates/partials/signal_breakdown.html`:**

A reusable partial that renders the signal score breakdown for a single pair. Expects a `signal` variable (SignalBreakdown dict from to_dict()) or None.

```html
{% if signal %}
<div class="bg-dash-card/50 rounded p-3 border border-dash-border/50">
  <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Signal Breakdown</h4>
  <div class="space-y-1.5">
    <!-- Composite Score -->
    <div class="flex items-center justify-between text-xs">
      <span class="text-gray-300">Composite</span>
      <span class="font-mono text-white">{{ "%.2f" | format(signal.composite_score | float) }}</span>
    </div>
    <!-- Sub-signal bars: rate_level, trend_score, persistence, basis_score -->
    {% for name, value, label in [
      ('rate_level', signal.rate_level, 'Rate Level'),
      ('trend_score', signal.trend_score, 'Trend'),
      ('persistence', signal.persistence, 'Persistence'),
      ('basis_score', signal.basis_score, 'Basis')
    ] %}
    <div class="flex items-center gap-2 text-xs">
      <span class="text-gray-400 w-20 shrink-0">{{ label }}</span>
      <div class="flex-1 h-2 bg-gray-700 rounded-full overflow-hidden">
        <div class="h-full bg-blue-500 rounded-full" style="width: {{ (value | float * 100) | int }}%"></div>
      </div>
      <span class="font-mono text-gray-300 w-8 text-right">{{ "%.2f" | format(value | float) }}</span>
    </div>
    {% endfor %}
    <!-- Volume filter -->
    <div class="flex items-center justify-between text-xs">
      <span class="text-gray-400">Volume</span>
      {% if signal.volume_ok %}
        <span class="text-green-400">Pass</span>
      {% else %}
        <span class="text-red-400">Fail</span>
      {% endif %}
    </div>
  </div>
</div>
{% else %}
<div class="bg-dash-card/50 rounded p-3 border border-dash-border/50">
  <p class="text-xs text-gray-500 italic">Signal data unavailable</p>
</div>
{% endif %}
```

**Create `src/bot/dashboard/templates/decision.html`:**

Extends `base.html`. The "Should I Trade?" summary page.

Structure:
1. `{% block title %}Decision Context{% endblock %}`
2. `{% block content %}` with:

**Glossary tooltip macro** (define at top of content block):
```html
{% macro tooltip(text, explanation) %}
<span class="relative group cursor-help">
  <span class="underline decoration-dotted decoration-gray-500">{{ text }}</span>
  <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 rounded bg-gray-800 text-xs text-gray-200 max-w-xs whitespace-normal opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 border border-dash-border shadow-lg">
    {{ explanation }}
  </span>
</span>
{% endmacro %}
```

**Page header:**
```html
<div class="mb-6">
  <h1 class="text-xl font-semibold text-white mb-1">Should I Trade?</h1>
  <p class="text-sm text-gray-400">Evidence-backed recommendations for all tracked pairs with live funding rates</p>
</div>
```

**Glossary bar** -- a horizontal row of key metric definitions using tooltip macro:
```html
<div class="bg-dash-card rounded-lg p-3 border border-dash-border mb-6 flex flex-wrap gap-4 text-sm">
  {{ tooltip("Percentile", "Where the current rate sits historically. P75 = rate is higher than 75% of observations.") }}
  {{ tooltip("Trend", "Direction of recent funding rate movement based on EMA analysis. Rising/Stable/Falling.") }}
  {{ tooltip("Composite Score", "Weighted combination of rate level (35%), trend (25%), persistence (25%), and basis (15%).") }}
  {{ tooltip("Action Label", "Evidence-based recommendation from percentile rank, trend direction, and signal score.") }}
  {{ tooltip("Confidence", "How much historical data supports the recommendation. High = 90+ data points.") }}
  {{ tooltip("Ann. Yield", "Fee-adjusted per-period yield extrapolated to one year. Assumes constant rate.") }}
  {{ tooltip("Persistence", "How long the rate stayed above threshold. Higher = more consistent opportunity.") }}
  {{ tooltip("Basis Spread", "Premium/discount of perpetual vs spot price. Positive basis supports positive funding.") }}
</div>
```

**Loading state and pair cards container:**
```html
<div id="decision-cards" class="text-center text-gray-500 py-8">
  <p>Loading decision contexts...</p>
</div>
```

3. `{% block scripts %}` with JavaScript (IIFE pattern):

```javascript
(function() {
  async function loadDecisions() {
    const container = document.getElementById('decision-cards');
    try {
      const resp = await fetch('/api/decision/summary');
      if (!resp.ok) {
        container.innerHTML = '<p class="text-gray-500 italic">Decision engine not available. Enable historical data collection to use this feature.</p>';
        return;
      }
      const data = await resp.json();
      const symbols = Object.keys(data);

      if (symbols.length === 0) {
        container.innerHTML = '<p class="text-gray-500 italic">No pairs with live funding rates found.</p>';
        return;
      }

      // Sort: Strong first, then Moderate, then Below average, then Not recommended, then Insufficient
      const labelOrder = {'Strong opportunity': 0, 'Moderate opportunity': 1, 'Below average': 2, 'Not recommended': 3, 'Insufficient data': 4};
      symbols.sort((a, b) => {
        const la = labelOrder[data[a].action.label] ?? 5;
        const lb = labelOrder[data[b].action.label] ?? 5;
        return la - lb;
      });

      // Summary stats
      const strong = symbols.filter(s => data[s].action.label === 'Strong opportunity').length;
      const moderate = symbols.filter(s => data[s].action.label === 'Moderate opportunity').length;
      const total = symbols.length;

      let html = `<div class="mb-4 text-left"><span class="text-sm text-gray-300">${strong} strong, ${moderate} moderate out of ${total} pairs</span></div>`;
      html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

      for (const sym of symbols) {
        const ctx = data[sym];
        const rc = ctx.rate_context;
        const action = ctx.action;
        const signal = ctx.signal_breakdown;

        // Action label color
        const labelColors = {
          'Strong opportunity': 'bg-blue-500/20 text-blue-300 border-blue-500/30',
          'Moderate opportunity': 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30',
          'Below average': 'bg-amber-500/20 text-amber-300 border-amber-500/30',
          'Not recommended': 'bg-red-500/20 text-red-300 border-red-500/30',
          'Insufficient data': 'bg-gray-500/20 text-gray-400 border-gray-500/30',
        };
        const lc = labelColors[action.label] || 'bg-gray-500/20 text-gray-400 border-gray-500/30';

        // Trend arrow
        const trendArrows = {rising: '<span class="text-green-400">&#9650;</span>', falling: '<span class="text-red-400">&#9660;</span>', stable: '<span class="text-gray-500">&#9644;</span>'};
        const trendArrow = trendArrows[rc.trend] || '';

        // Percentile color
        const p = parseInt(rc.percentile);
        const pColor = p >= 75 ? 'text-blue-300' : p >= 50 ? 'text-cyan-300' : p >= 25 ? 'text-amber-300' : 'text-gray-400';

        html += `
          <div class="bg-dash-card rounded-lg p-4 border border-dash-border hover:border-dash-border/80">
            <div class="flex items-center justify-between mb-2">
              <span class="font-mono text-sm text-white">${sym.replace('/USDT:USDT', '')}</span>
              <span class="text-xs px-2 py-0.5 rounded ${lc}">${action.label}</span>
            </div>
            <div class="grid grid-cols-3 gap-2 text-xs mb-3">
              <div>
                <span class="text-gray-500 block">Percentile</span>
                <span class="${pColor} font-mono">P${p}</span>
              </div>
              <div>
                <span class="text-gray-500 block">Trend</span>
                <span>${trendArrow} <span class="text-gray-300 capitalize">${rc.trend}</span></span>
              </div>
              <div>
                <span class="text-gray-500 block">Rate</span>
                <span class="font-mono text-gray-300">${(parseFloat(rc.current_rate) * 100).toFixed(4)}%</span>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-2 text-xs mb-3">
              <div>
                <span class="text-gray-500 block">Avg Rate</span>
                <span class="font-mono text-gray-300">${(parseFloat(rc.avg_rate) * 100).toFixed(4)}%</span>
              </div>
              <div>
                <span class="text-gray-500 block">Z-Score</span>
                <span class="font-mono text-gray-300">${parseFloat(rc.z_score).toFixed(2)}</span>
              </div>
              <div>
                <span class="text-gray-500 block">Confidence</span>
                <span class="text-gray-300 capitalize">${action.confidence}</span>
              </div>
            </div>
            ${signal ? `
            <div class="border-t border-dash-border/50 pt-2 mt-2">
              <span class="text-xs text-gray-500 block mb-1">Signal Score: <span class="font-mono text-white">${parseFloat(signal.composite_score).toFixed(2)}</span></span>
              <div class="grid grid-cols-4 gap-1 text-xs">
                <div title="Rate Level"><div class="h-1 bg-gray-700 rounded"><div class="h-1 bg-blue-500 rounded" style="width:${(parseFloat(signal.rate_level)*100).toFixed(0)}%"></div></div><span class="text-gray-500">Rate</span></div>
                <div title="Trend"><div class="h-1 bg-gray-700 rounded"><div class="h-1 bg-blue-500 rounded" style="width:${(parseFloat(signal.trend_score)*100).toFixed(0)}%"></div></div><span class="text-gray-500">Trend</span></div>
                <div title="Persistence"><div class="h-1 bg-gray-700 rounded"><div class="h-1 bg-blue-500 rounded" style="width:${(parseFloat(signal.persistence)*100).toFixed(0)}%"></div></div><span class="text-gray-500">Persist</span></div>
                <div title="Basis"><div class="h-1 bg-gray-700 rounded"><div class="h-1 bg-blue-500 rounded" style="width:${(parseFloat(signal.basis_score)*100).toFixed(0)}%"></div></div><span class="text-gray-500">Basis</span></div>
              </div>
            </div>
            ` : '<div class="border-t border-dash-border/50 pt-2 mt-2"><span class="text-xs text-gray-500 italic">Signal data unavailable</span></div>'}
            <div class="border-t border-dash-border/50 pt-2 mt-2">
              <div class="text-xs text-gray-500">
                ${action.reasons.map(r => '<div class="mt-0.5">- ' + r + '</div>').join('')}
              </div>
            </div>
          </div>`;
      }
      html += '</div>';
      container.innerHTML = html;
    } catch (e) {
      container.innerHTML = '<p class="text-red-400">Error loading decision contexts: ' + e.message + '</p>';
    }
  }
  loadDecisions();
})();
```

**Modify `src/bot/dashboard/routes/pages.py`:**

Add a new route for the decision page:

```python
@router.get("/decision", response_class=HTMLResponse)
async def decision_page(request: Request) -> HTMLResponse:
    """Decision Context page -- evidence-backed trading recommendations (DCSN-05)."""
    templates: Jinja2Templates = request.app.state.templates
    return templates.TemplateResponse("decision.html", {"request": request})
```

**Modify `src/bot/dashboard/templates/base.html`:**

Add a "Decision" link in the nav bar, after the "Backtest" link:
```html
<a href="/decision" class="text-gray-400 hover:text-white text-sm">Decision</a>
```

This goes in the `<div class="flex items-center gap-4">` alongside Dashboard, Pairs, and Backtest links.
  </action>
  <verify>
Verify templates parse without errors:
`python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('src/bot/dashboard/templates')); t = env.get_template('decision.html'); print('decision.html OK')"`

`python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('src/bot/dashboard/templates')); t = env.get_template('partials/signal_breakdown.html'); print('signal_breakdown.html OK')"`

Verify pages route imports: `python -c "from bot.dashboard.routes.pages import router; print('pages OK')"`

Verify base.html has Decision nav link: `grep -c 'href="/decision"' src/bot/dashboard/templates/base.html` should print 1.

Run `python -m pytest tests/ -x -q 2>&1 | tail -5` to verify no regressions.
  </verify>
  <done>
Funding rates panel displays percentile badges (P0-P100 with blue/cyan/amber/gray color tiers), trend arrows (rising/stable/falling), and action labels for each pair. Decision summary page at /decision shows sorted pair cards with rate context, signal breakdown bars, action labels with reasons, and confidence levels. Glossary bar with hover tooltips explains all key metrics. Navigation bar includes "Decision" link. signal_breakdown.html partial available for reuse. WebSocket updates include decision context data. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. Navigate to main dashboard (/) -- funding rates panel shows Pctl, Trend, and Action columns
2. Navigate to /decision -- summary page loads with pair cards sorted by recommendation quality
3. Hover over glossary terms on /decision page -- tooltips appear with explanations
4. WebSocket updates refresh funding rates panel with decision context data every 5 seconds
5. When decision engine unavailable (no data_store), panels degrade gracefully with empty columns
6. `python -m pytest tests/ -x -q` passes with no regressions
</verification>

<success_criteria>
- Funding rates panel has 3 new columns: percentile badge, trend arrow, action label
- Decision summary page shows all pairs with live rates, sorted by recommendation quality
- Each card shows rate context (percentile, trend, current/avg rate, z-score), signal breakdown bars, action label with confidence and evidence reasons
- Glossary tooltips explain key metrics on hover (no JS tooltip library)
- Blue-tone color palette for decision context (distinct from green/red rate values)
- Navigation bar includes Decision link
- All features degrade gracefully when dependencies unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/11-decision-context/11-02-SUMMARY.md`
</output>
