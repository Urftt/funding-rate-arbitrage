---
phase: 02-multi-pair-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bot/config.py
  - src/bot/models.py
  - src/bot/exceptions.py
  - src/bot/exchange/client.py
  - src/bot/exchange/bybit_client.py
  - src/bot/execution/paper_executor.py
  - .env.example
autonomous: true

must_haves:
  truths:
    - "RiskSettings loads from RISK_ prefixed environment variables"
    - "OpportunityScore dataclass holds net yield and annualized yield as Decimal"
    - "ExchangeClient ABC includes fetch_wallet_balance_raw and get_markets methods"
    - "BybitClient implements fetch_wallet_balance_raw using raw info dict"
    - "PaperExecutor can simulate wallet balance with configurable virtual equity"
  artifacts:
    - path: "src/bot/config.py"
      provides: "RiskSettings with env_prefix=RISK_"
      contains: "class RiskSettings"
    - path: "src/bot/models.py"
      provides: "OpportunityScore dataclass"
      contains: "class OpportunityScore"
    - path: "src/bot/exceptions.py"
      provides: "RiskLimitExceeded and EmergencyStopTriggered exceptions"
      contains: "class RiskLimitExceeded"
    - path: "src/bot/exchange/client.py"
      provides: "fetch_wallet_balance_raw and get_markets abstract methods"
      contains: "fetch_wallet_balance_raw"
    - path: "src/bot/exchange/bybit_client.py"
      provides: "Concrete wallet balance and markets implementation"
      contains: "fetch_wallet_balance_raw"
    - path: ".env.example"
      provides: "Documented RISK_ environment variables"
      contains: "RISK_MAX_POSITION_SIZE_PER_PAIR"
  key_links:
    - from: "src/bot/config.py"
      to: "src/bot/config.py (AppSettings)"
      via: "RiskSettings composed into AppSettings.risk"
      pattern: "risk.*RiskSettings"
    - from: "src/bot/exchange/bybit_client.py"
      to: "ccxt fetch_balance"
      via: "Raw info dict access for accountMMRate"
      pattern: "accountMMRate"
---

<objective>
Add Phase 2 foundation: RiskSettings configuration, OpportunityScore model, new exception types, and exchange client extensions for margin monitoring and spot symbol derivation.

Purpose: All Phase 2 components (ranker, risk manager, emergency controller, orchestrator) depend on these shared types, config, and exchange methods. Building them first unblocks parallel work.
Output: Extended config.py, models.py, exceptions.py, exchange client ABC + BybitClient, .env.example with all RISK_ variables.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-pair-intelligence/02-RESEARCH.md
@src/bot/config.py
@src/bot/models.py
@src/bot/exceptions.py
@src/bot/exchange/client.py
@src/bot/exchange/bybit_client.py
@src/bot/execution/paper_executor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RiskSettings, OpportunityScore, and new exceptions</name>
  <files>src/bot/config.py, src/bot/models.py, src/bot/exceptions.py, .env.example</files>
  <action>
1. In `src/bot/config.py`:
   - Add `RiskSettings(BaseSettings)` with `model_config = SettingsConfigDict(env_prefix="RISK_")` and these fields (all Decimal except int fields):
     - `max_position_size_per_pair: Decimal = Decimal("1000")` (USD per pair)
     - `max_simultaneous_positions: int = 5`
     - `exit_funding_rate: Decimal = Decimal("0.0001")` (0.01%/period -- close below this)
     - `margin_alert_threshold: Decimal = Decimal("0.8")` (alert at 80% MMR)
     - `margin_critical_threshold: Decimal = Decimal("0.9")` (emergency at 90% MMR)
     - `min_volume_24h: Decimal = Decimal("1000000")` ($1M minimum)
     - `min_holding_periods: int = 3` (minimum funding periods to hold)
   - Add `risk: RiskSettings = RiskSettings()` field to `AppSettings`
   - Add `scan_interval: int = 60` to `TradingSettings` (seconds between autonomous scan cycles)

2. In `src/bot/models.py`:
   - Add `OpportunityScore` dataclass with fields:
     - `spot_symbol: str`
     - `perp_symbol: str`
     - `funding_rate: Decimal` (raw per-period rate)
     - `funding_interval_hours: int` (4 or 8)
     - `volume_24h: Decimal`
     - `net_yield_per_period: Decimal` (rate minus amortized round-trip fee)
     - `annualized_yield: Decimal` (net_yield * periods_per_year)
     - `passes_filters: bool` (volume, rate, spot-availability checks)

3. In `src/bot/exceptions.py`:
   - Add `RiskLimitExceeded(BotError)` with docstring "Raised when a risk limit prevents opening a new position."
   - Add `EmergencyStopTriggered(BotError)` with docstring "Raised when emergency stop is activated."

4. Create or update `.env.example` with all RISK_ variables documented:
   ```
   # Risk Management (Phase 2)
   RISK_MAX_POSITION_SIZE_PER_PAIR=1000
   RISK_MAX_SIMULTANEOUS_POSITIONS=5
   RISK_EXIT_FUNDING_RATE=0.0001
   RISK_MARGIN_ALERT_THRESHOLD=0.8
   RISK_MARGIN_CRITICAL_THRESHOLD=0.9
   RISK_MIN_VOLUME_24H=1000000
   RISK_MIN_HOLDING_PERIODS=3
   TRADING_SCAN_INTERVAL=60
   ```
   Include existing Phase 1 variables too (BYBIT_, TRADING_, FEES_ prefixes).
  </action>
  <verify>
  Run `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/python -c "from bot.config import AppSettings, RiskSettings; s = RiskSettings(); print(s.max_position_size_per_pair, s.max_simultaneous_positions); a = AppSettings(); print(type(a.risk))"` -- should print Decimal values and RiskSettings type.
  Run `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/python -c "from bot.models import OpportunityScore; from decimal import Decimal; o = OpportunityScore(spot_symbol='BTC/USDT', perp_symbol='BTC/USDT:USDT', funding_rate=Decimal('0.0005'), funding_interval_hours=8, volume_24h=Decimal('5000000'), net_yield_per_period=Decimal('0.0003'), annualized_yield=Decimal('0.33'), passes_filters=True); print(o.annualized_yield)"` -- should print 0.33.
  Run `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/python -c "from bot.exceptions import RiskLimitExceeded, EmergencyStopTriggered; print('OK')"`.
  </verify>
  <done>RiskSettings loads with defaults and is accessible via AppSettings().risk. OpportunityScore dataclass instantiable with all fields. RiskLimitExceeded and EmergencyStopTriggered exceptions importable. .env.example documents all RISK_ variables.</done>
</task>

<task type="auto">
  <name>Task 2: Extend ExchangeClient ABC and BybitClient with margin and market access</name>
  <files>src/bot/exchange/client.py, src/bot/exchange/bybit_client.py, src/bot/execution/paper_executor.py</files>
  <action>
1. In `src/bot/exchange/client.py` (ExchangeClient ABC):
   - Add abstract method `fetch_wallet_balance_raw(self) -> dict` that returns the raw Bybit wallet balance dict containing accountMMRate, totalMaintenanceMargin, totalEquity, totalAvailableBalance. Docstring should specify these fields.
   - Add abstract method `get_markets(self) -> dict` that returns the cached markets dict from load_markets(). This is needed by OpportunityRanker to derive spot symbols without triggering new API calls.

2. In `src/bot/exchange/bybit_client.py` (BybitClient):
   - Implement `fetch_wallet_balance_raw()`:
     ```python
     async def fetch_wallet_balance_raw(self) -> dict:
         balance = await self._exchange.fetch_balance(params={"type": "UNIFIED"})
         raw_info = balance.get("info", {})
         result_list = raw_info.get("result", {}).get("list", [])
         if result_list:
             return result_list[0]
         return {}
     ```
   - Implement `get_markets()`:
     ```python
     def get_markets(self) -> dict:
         return self._markets
     ```
     Note: This is synchronous since markets are loaded at connect() time.
     Update the ABC to be non-async for this method: `def get_markets(self) -> dict`.

3. In `src/bot/execution/paper_executor.py`:
   - The PaperExecutor currently tracks virtual balance. It does NOT implement ExchangeClient, but the RiskManager will need margin data in paper mode. Add a module-level helper function (not on PaperExecutor itself):
     ```python
     def simulate_paper_margin(
         open_position_count: int,
         max_position_size_usd: Decimal,
         virtual_equity: Decimal,
     ) -> dict:
         """Simulate margin data for paper trading mode.
         Returns a dict mimicking fetch_wallet_balance_raw() shape."""
         total_used = max_position_size_usd * Decimal(str(open_position_count))
         mm_rate = total_used / virtual_equity if virtual_equity > 0 else Decimal("0")
         return {
             "accountMMRate": str(mm_rate),
             "totalMaintenanceMargin": str(total_used * Decimal("0.05")),
             "totalEquity": str(virtual_equity),
             "totalAvailableBalance": str(virtual_equity - total_used),
         }
     ```
   - Add `paper_virtual_equity: Decimal = Decimal("10000")` field to RiskSettings in config.py (for paper mode margin simulation).
  </action>
  <verify>
  Run `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/python -c "from bot.exchange.client import ExchangeClient; print([m for m in dir(ExchangeClient) if 'wallet' in m or 'markets' == m])"` -- should show fetch_wallet_balance_raw and get_markets.
  Run `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/python -c "from bot.execution.paper_executor import simulate_paper_margin; from decimal import Decimal; r = simulate_paper_margin(2, Decimal('1000'), Decimal('10000')); print(r['accountMMRate'], r['totalAvailableBalance'])"` -- should print 0.2 and 8000.
  Run existing tests: `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/python -m pytest tests/ -x -q` -- all existing tests must still pass (no regressions from ABC changes).
  </verify>
  <done>ExchangeClient ABC has fetch_wallet_balance_raw and get_markets abstract methods. BybitClient implements both. simulate_paper_margin function exists for paper mode margin simulation. All existing tests pass.</done>
</task>

</tasks>

<verification>
1. `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/python -c "from bot.config import AppSettings; s = AppSettings(); print(s.risk.max_simultaneous_positions, s.trading.scan_interval)"` prints `5 60`
2. `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/python -m pytest tests/ -x -q` -- all tests pass
3. `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && .venv/bin/ruff check src/bot/config.py src/bot/models.py src/bot/exceptions.py src/bot/exchange/client.py src/bot/exchange/bybit_client.py` -- no lint errors
</verification>

<success_criteria>
- RiskSettings with 8 configurable fields loadable from RISK_ env vars
- OpportunityScore dataclass with all required fields
- RiskLimitExceeded and EmergencyStopTriggered exceptions in exceptions.py
- ExchangeClient ABC extended with fetch_wallet_balance_raw and get_markets
- BybitClient implements both new methods
- Paper mode margin simulation function available
- All existing Phase 1 tests pass without modification
- .env.example documents all configuration
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-pair-intelligence/02-01-SUMMARY.md`
</output>
