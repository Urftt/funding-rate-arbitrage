---
phase: 06-backtest-engine
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/bot/backtest/sweep.py
  - src/bot/backtest/__init__.py
  - src/bot/main.py
autonomous: true

must_haves:
  truths:
    - "User can sweep over entry/exit thresholds and signal weights to find optimal parameters (BKTS-03)"
    - "ParameterSweep generates all combinations via itertools.product and runs a backtest for each"
    - "Sweep results include the parameter combination and final metrics for each run"
    - "User can run backtests and sweeps from the command line via main.py --backtest"
  artifacts:
    - path: "src/bot/backtest/sweep.py"
      provides: "ParameterSweep class for grid search over parameter combinations"
      contains: "class ParameterSweep"
    - path: "src/bot/main.py"
      provides: "CLI entry point for backtest and sweep commands"
      contains: "backtest"
  key_links:
    - from: "src/bot/backtest/sweep.py"
      to: "src/bot/backtest/runner.py"
      via: "run_backtest() called for each parameter combination"
      pattern: "run_backtest\\("
    - from: "src/bot/main.py"
      to: "src/bot/backtest/runner.py"
      via: "CLI argument parsing dispatches to run_backtest_cli"
      pattern: "run_backtest"
---

<objective>
Build the parameter sweep engine and wire backtest commands into main.py CLI.

Purpose: Satisfies BKTS-03 (parameter sweep over entry/exit thresholds and signal weights). Provides the user-facing CLI interface to run backtests and sweeps. The sweep produces a results matrix that Plan 04's dashboard will visualize as a heatmap.

Output: ParameterSweep class, updated main.py with --backtest and --sweep CLI commands.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backtest-engine/06-01-SUMMARY.md
@.planning/phases/06-backtest-engine/06-02-SUMMARY.md

@src/bot/backtest/models.py
@src/bot/backtest/runner.py
@src/bot/backtest/engine.py
@src/bot/main.py
@src/bot/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ParameterSweep grid search engine</name>
  <files>
    src/bot/backtest/sweep.py
    src/bot/backtest/__init__.py
  </files>
  <action>
**src/bot/backtest/sweep.py**: Create `ParameterSweep` class.

```python
from itertools import product
```

**class ParameterSweep:**

1. `__init__(self, db_path: str = "data/historical.db", fee_settings: FeeSettings | None = None, backtest_settings: BacktestSettings | None = None)` -- store config for reuse across runs.

2. `async def run(self, base_config: BacktestConfig, param_grid: dict[str, list], progress_callback: Callable | None = None) -> SweepResult`:
   - Validate param_grid keys are valid BacktestConfig fields using `hasattr(base_config, key)` for each key
   - Generate all combinations: `keys = list(param_grid.keys())`, `values = list(param_grid.values())`, `combinations = list(product(*values))`
   - Log total combinations count at INFO level
   - For each combination:
     a. Build params dict: `params = dict(zip(keys, combo))`
     b. Convert string values to Decimal where needed (if the base config field is Decimal, wrap the value)
     c. Create override config: `config = base_config.with_overrides(**params)`
     d. Run backtest: `result = await run_backtest(config, self._db_path, self._fee_settings, self._backtest_settings)`
     e. Append `(params, result)` to results list
     f. Call progress_callback(current_index, total, params, result) if provided
     g. Log completion of each run at DEBUG level
   - Return `SweepResult(param_grid=param_grid, results=results)`

3. `def generate_default_grid(strategy_mode: str = "simple") -> dict[str, list]` (static method):
   For "simple" mode:
   ```python
   return {
       "min_funding_rate": [Decimal("0.0001"), Decimal("0.0002"), Decimal("0.0003"), Decimal("0.0005"), Decimal("0.0008")],
       "exit_funding_rate": [Decimal("0.00005"), Decimal("0.0001"), Decimal("0.0002")],
   }
   ```
   For "composite" mode:
   ```python
   return {
       "entry_threshold": [Decimal("0.3"), Decimal("0.4"), Decimal("0.5"), Decimal("0.6"), Decimal("0.7")],
       "exit_threshold": [Decimal("0.2"), Decimal("0.3"), Decimal("0.4")],
       "weight_rate_level": [Decimal("0.25"), Decimal("0.35"), Decimal("0.45")],
   }
   ```

4. Helper `format_sweep_summary(sweep_result: SweepResult) -> str`:
   - Format a text summary table showing each parameter combination and its net P&L, Sharpe ratio, win rate
   - Sort by net P&L descending
   - Return as a formatted string suitable for console output
   - Include the best parameter combination highlighted

**Memory management:** After extracting metrics from each BacktestResult, discard the full equity curve from the stored result to prevent memory growth. Keep only the metrics. Store the full equity curve only for the best result (highest net P&L).

Update `src/bot/backtest/__init__.py` to export `ParameterSweep`.
  </action>
  <verify>
    Run `python -c "from bot.backtest.sweep import ParameterSweep; print('sweep import OK')"`.
    Run `python -c "from bot.backtest.sweep import ParameterSweep; grid = ParameterSweep.generate_default_grid('simple'); print(f'Simple grid: {len(grid)} params, {sum(len(v) for v in grid.values())} values'); grid = ParameterSweep.generate_default_grid('composite'); print(f'Composite grid: {len(grid)} params')"`.
  </verify>
  <done>
    ParameterSweep.run() iterates over all param combinations via itertools.product, runs run_backtest() for each, and returns SweepResult. generate_default_grid() provides sensible defaults for both strategy modes. format_sweep_summary() produces a readable text table sorted by P&L.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire backtest CLI commands into main.py</name>
  <files>src/bot/main.py</files>
  <action>
Read the current `src/bot/main.py` to understand the existing CLI structure (it likely uses argparse or a simple if/else on sys.argv).

Add backtest CLI support with two subcommands:

**Option A (if main.py uses argparse):** Add a subparser for "backtest" with arguments:
- `--symbol` (required): Perpetual symbol (e.g., "BTC/USDT:USDT")
- `--start` (required): Start date as YYYY-MM-DD
- `--end` (required): End date as YYYY-MM-DD
- `--strategy` (default: "simple"): Strategy mode ("simple" or "composite")
- `--compare`: Flag to run v1.0 vs v1.1 comparison
- `--sweep`: Flag to run parameter sweep instead of single backtest
- `--min-rate` (optional): Override min_funding_rate
- `--entry-threshold` (optional): Override entry_threshold for composite
- `--exit-threshold` (optional): Override exit_threshold

**Option B (if main.py uses simple argv or no CLI parsing):** Add `--backtest` flag detection early in main(), before the normal bot startup:

```python
import sys

if "--backtest" in sys.argv:
    asyncio.run(_run_backtest_cli())
    sys.exit(0)
```

Then implement `async def _run_backtest_cli()` that parses the remaining arguments.

**CLI behavior:**

1. **Single backtest** (`python -m bot.main --backtest --symbol BTC/USDT:USDT --start 2025-01-01 --end 2025-06-01`):
   - Parse dates to millisecond timestamps
   - Create BacktestConfig
   - Call run_backtest()
   - Print summary: net P&L, total trades, Sharpe, max drawdown, win rate, duration

2. **Comparison** (`python -m bot.main --backtest --compare --symbol BTC/USDT:USDT --start 2025-01-01 --end 2025-06-01`):
   - Create two configs (simple and composite) with same symbol/dates
   - Call run_comparison()
   - Print side-by-side comparison table

3. **Parameter sweep** (`python -m bot.main --backtest --sweep --symbol BTC/USDT:USDT --start 2025-01-01 --end 2025-06-01 --strategy composite`):
   - Create base config
   - Generate default grid for the strategy mode
   - Create ParameterSweep and run
   - Print sweep summary using format_sweep_summary()

**Console output format:** Use simple print() with aligned columns. No external dependency for formatting (no rich, no tabulate). Example:
```
=== Backtest Results ===
Symbol:      BTC/USDT:USDT
Period:      2025-01-01 to 2025-06-01 (151 days)
Strategy:    simple
Net P&L:     $42.35
Total Trades: 15
Win Rate:    73.3%
Sharpe Ratio: 1.85
Max Drawdown: $12.50
Total Fees:  $8.20
Total Funding: $50.55
```

Keep the existing main() bot startup logic completely unchanged. The backtest CLI is a separate code path that exits before bot startup.
  </action>
  <verify>
    Run `python -m bot.main --help 2>&1 | head -20` to verify help text shows backtest options.
    Run `python -c "import bot.main; print('main import OK')"` to verify no import errors.
    Run `python -m pytest tests/ -x -q --timeout=30 2>&1 | tail -5` to verify no existing tests broken.
  </verify>
  <done>
    User can run `python -m bot.main --backtest --symbol X --start YYYY-MM-DD --end YYYY-MM-DD` for single backtest. --compare runs v1.0 vs v1.1 side-by-side. --sweep runs parameter grid search. Existing bot startup is unaffected.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from bot.backtest.sweep import ParameterSweep"` succeeds
2. `python -m bot.main --backtest --help` shows backtest CLI options
3. ParameterSweep.generate_default_grid() returns valid grids for both strategy modes
4. All existing tests pass: `python -m pytest tests/ -x -q`
5. Existing bot startup (`python -m bot.main` without --backtest) is unaffected
</verification>

<success_criteria>
- ParameterSweep.run() iterates over all parameter combinations and returns SweepResult
- Default grids cover sensible ranges for simple (min_rate x exit_rate) and composite (entry x exit x weight)
- CLI --backtest command parses dates and runs single backtest with console output
- CLI --compare runs both strategies and prints side-by-side comparison
- CLI --sweep runs grid search and prints sorted results table
- Memory is managed: only best result keeps full equity curve
- Existing main.py bot startup is completely unmodified
</success_criteria>

<output>
After completion, create `.planning/phases/06-backtest-engine/06-03-SUMMARY.md`
</output>
