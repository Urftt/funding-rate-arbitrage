---
phase: 01-core-trading-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/bot/__init__.py
  - src/bot/config.py
  - src/bot/models.py
  - src/bot/logging.py
  - src/bot/main.py
  - src/bot/exchange/__init__.py
  - src/bot/execution/__init__.py
  - src/bot/market_data/__init__.py
  - src/bot/position/__init__.py
  - src/bot/pnl/__init__.py
  - src/bot/risk/__init__.py
  - tests/__init__.py
  - tests/conftest.py
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Project installs cleanly with `pip install -e .` and all dependencies resolve"
    - "Configuration loads from environment variables and .env files with type validation"
    - "All shared data models (FundingRateData, OrderRequest, OrderResult, Position, etc.) are importable and type-safe"
    - "Structured JSON logging works with async context propagation"
  artifacts:
    - path: "pyproject.toml"
      provides: "Project metadata, dependencies, dev dependencies, tool config"
      contains: "ccxt"
    - path: "src/bot/config.py"
      provides: "Pydantic settings for exchange, trading, fees"
      exports: ["AppSettings", "ExchangeSettings", "TradingSettings", "FeeSettings"]
    - path: "src/bot/models.py"
      provides: "Shared data models for the entire bot"
      exports: ["FundingRateData", "OrderSide", "OrderType", "OrderRequest", "OrderResult", "PositionSide", "Position", "DeltaStatus"]
    - path: "src/bot/logging.py"
      provides: "Structured logging configuration"
      exports: ["setup_logging", "get_logger"]
  key_links:
    - from: "src/bot/config.py"
      to: ".env / environment variables"
      via: "pydantic-settings env_prefix"
      pattern: "env_prefix.*BYBIT|TRADING|FEES"
    - from: "src/bot/models.py"
      to: "decimal.Decimal"
      via: "all monetary fields use Decimal"
      pattern: "Decimal"
---

<objective>
Set up the project foundation: Python package structure, dependency management, configuration system, shared data models, and structured logging.

Purpose: Every subsequent plan imports from config.py and models.py. This foundation must be solid -- type-safe, Decimal-based, and properly structured -- because all business logic builds on these primitives.

Output: Installable Python package with pyproject.toml, fully typed configuration, shared data models, structlog-based logging, and test infrastructure.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-trading-engine/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffold with pyproject.toml and package structure</name>
  <files>
    pyproject.toml
    src/bot/__init__.py
    src/bot/exchange/__init__.py
    src/bot/execution/__init__.py
    src/bot/market_data/__init__.py
    src/bot/position/__init__.py
    src/bot/pnl/__init__.py
    src/bot/risk/__init__.py
    src/bot/main.py
    tests/__init__.py
    tests/conftest.py
    .env.example
  </files>
  <action>
    Create pyproject.toml with:
    - Project name: `funding-rate-arbitrage`
    - Python >=3.12
    - Core dependencies: `ccxt>=4.5.0`, `pydantic>=2.5`, `pydantic-settings>=2.12`, `structlog>=25.5`, `aiolimiter>=1.2`, `python-dotenv>=1.0`
    - Dev dependencies group: `pytest>=8.0`, `pytest-asyncio>=0.23`, `pytest-mock>=3.12`, `ruff>=0.4`, `mypy>=1.8`
    - Entry point: `[project.scripts] funding-arb = "bot.main:main"`
    - Tool config for ruff (target Python 3.12, line-length 120) and pytest (asyncio_mode = "auto")
    - Use `src` layout: `[tool.setuptools.packages.find] where = ["src"]`

    Create all `__init__.py` files as empty files (just a docstring describing the module purpose).

    Create `src/bot/main.py` as a placeholder entry point:
    ```python
    import asyncio
    from bot.config import AppSettings
    from bot.logging import setup_logging, get_logger

    async def run():
        settings = AppSettings()
        setup_logging(settings.log_level)
        logger = get_logger("bot.main")
        logger.info("funding_rate_arbitrage_starting", mode=settings.trading.mode)
        # Orchestrator will be wired here in Plan 05
        logger.info("funding_rate_arbitrage_stopped")

    def main():
        asyncio.run(run())

    if __name__ == "__main__":
        main()
    ```

    Create `tests/conftest.py` with basic fixtures: a `mock_settings` fixture returning an AppSettings with test defaults (paper mode, dummy API keys).

    Create `.env.example` showing all environment variables with placeholder values and comments explaining each.
  </action>
  <verify>
    Run: `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && pip install -e ".[dev]" 2>&1 | tail -5`
    Expect: successful installation with no errors.
    Run: `python -c "from bot.config import AppSettings; print('config OK')"`
    Run: `python -c "from bot.models import OrderRequest; print('models OK')"`
  </verify>
  <done>
    `pip install -e .` succeeds. All subpackage __init__.py files exist. pyproject.toml has all required dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement configuration system and shared data models</name>
  <files>
    src/bot/config.py
    src/bot/models.py
    src/bot/logging.py
  </files>
  <action>
    **config.py** -- Pydantic settings with env var loading:

    Create `ExchangeSettings(BaseSettings)` with:
    - `model_config = SettingsConfigDict(env_prefix="BYBIT_")`
    - `api_key: SecretStr = SecretStr("")` (default empty for paper mode)
    - `api_secret: SecretStr = SecretStr("")`
    - `testnet: bool = False`
    - `demo_trading: bool = False`

    Create `TradingSettings(BaseSettings)` with:
    - `model_config = SettingsConfigDict(env_prefix="TRADING_")`
    - `mode: Literal["paper", "live"] = "paper"`
    - `max_position_size_usd: Decimal = Decimal("1000")`
    - `min_funding_rate: Decimal = Decimal("0.0003")` (0.03%/8h minimum viable per research)
    - `delta_drift_tolerance: Decimal = Decimal("0.02")` (2% max)
    - `order_timeout_seconds: float = 5.0`

    Create `FeeSettings(BaseSettings)` with:
    - `model_config = SettingsConfigDict(env_prefix="FEES_")`
    - `spot_taker: Decimal = Decimal("0.001")` (0.1%)
    - `spot_maker: Decimal = Decimal("0.001")`
    - `perp_taker: Decimal = Decimal("0.00055")` (0.055%)
    - `perp_maker: Decimal = Decimal("0.0002")` (0.02%)

    Create `AppSettings(BaseSettings)` composing the above, plus:
    - `model_config = SettingsConfigDict(env_file=".env", env_file_encoding="utf-8", env_nested_delimiter="__")`
    - `log_level: str = "INFO"`
    - `exchange: ExchangeSettings`
    - `trading: TradingSettings`
    - `fees: FeeSettings`
    - Use `model_validator` or field defaults so nested models initialize from env vars correctly

    **models.py** -- Shared data models using dataclasses and enums:

    Create enums: `OrderSide(str, Enum)` with BUY/SELL, `OrderType(str, Enum)` with MARKET/LIMIT, `PositionSide(str, Enum)` with LONG/SHORT.

    Create dataclasses (using `@dataclass`):
    - `FundingRateData`: symbol (str), rate (Decimal), next_funding_time (int, unix ms), interval_hours (int, default 8), mark_price (Decimal), volume_24h (Decimal), updated_at (float, time.time())
    - `OrderRequest`: symbol (str), side (OrderSide), order_type (OrderType), quantity (Decimal), price (Decimal | None = None), category (str = "linear")
    - `OrderResult`: order_id (str), symbol (str), side (OrderSide), filled_qty (Decimal), filled_price (Decimal), fee (Decimal), timestamp (float), is_simulated (bool = False)
    - `Position`: id (str), spot_symbol (str), perp_symbol (str), side (PositionSide), quantity (Decimal), spot_entry_price (Decimal), perp_entry_price (Decimal), spot_order_id (str), perp_order_id (str), opened_at (float), entry_fee_total (Decimal)
    - `DeltaStatus`: position_id (str), spot_qty (Decimal), perp_qty (Decimal), drift_pct (Decimal), is_within_tolerance (bool), checked_at (float)

    ALL monetary/quantity fields MUST use `Decimal`, never `float`. Add a module-level comment:
    ```python
    # CRITICAL: All monetary values use Decimal. Never use float for prices, quantities, or fees.
    # See: .planning/phases/01-core-trading-engine/01-RESEARCH.md (Anti-Patterns)
    ```

    **logging.py** -- Structured logging with structlog:

    Create `setup_logging(log_level: str = "INFO")` that configures structlog with:
    - JSON renderer for production, ConsoleRenderer for development (detect via LOG_FORMAT env var or default to console)
    - `structlog.contextvars` for async context propagation (NOT threadlocal)
    - Processors: add_log_level, TimeStamper(fmt="iso"), StackInfoRenderer, format_exc_info
    - stdlib integration (ProcessorFormatter) for libraries that use stdlib logging

    Create `get_logger(name: str)` that returns a bound structlog logger.
  </action>
  <verify>
    Run: `python -c "
from bot.config import AppSettings
s = AppSettings()
assert s.trading.mode == 'paper'
assert s.fees.spot_taker == __import__('decimal').Decimal('0.001')
print('config defaults OK')
"`
    Run: `python -c "
from bot.models import OrderRequest, OrderSide, OrderType
from decimal import Decimal
o = OrderRequest(symbol='BTC/USDT', side=OrderSide.BUY, order_type=OrderType.MARKET, quantity=Decimal('0.1'))
assert isinstance(o.quantity, Decimal)
print('models OK')
"`
    Run: `python -c "
from bot.logging import setup_logging, get_logger
setup_logging('DEBUG')
log = get_logger('test')
log.info('test_message', key='value')
print('logging OK')
"`
  </verify>
  <done>
    AppSettings loads with correct defaults and respects environment variables. All data models use Decimal for monetary fields. structlog outputs structured JSON/console logs with async context support. No float used anywhere for prices/quantities/fees.
  </done>
</task>

</tasks>

<verification>
1. `pip install -e ".[dev]"` completes without errors
2. `python -c "from bot.config import AppSettings; AppSettings()"` succeeds
3. `python -c "from bot.models import FundingRateData, OrderRequest, OrderResult, Position, DeltaStatus"` succeeds
4. `python -c "from bot.logging import setup_logging, get_logger; setup_logging(); get_logger('test').info('ok')"` outputs structured log
5. `TRADING_MODE=live python -c "from bot.config import AppSettings; assert AppSettings().trading.mode == 'live'"` proves env var override works
6. All __init__.py files exist in expected locations
7. pyproject.toml has ccxt, pydantic, pydantic-settings, structlog in dependencies
</verification>

<success_criteria>
- Project installs cleanly as an editable package
- Configuration system validates and loads from env vars
- All shared data models are importable with Decimal fields
- Structured logging works
- Test infrastructure (conftest.py, pytest config) is ready
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-trading-engine/01-01-SUMMARY.md`
</output>
