---
phase: 01-core-trading-engine
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/bot/execution/executor.py
  - src/bot/execution/paper_executor.py
  - src/bot/execution/live_executor.py
  - src/bot/position/manager.py
  - src/bot/position/delta_validator.py
  - src/bot/risk/manager.py
  - tests/test_execution/__init__.py
  - tests/test_execution/test_paper_executor.py
  - tests/test_position/test_manager.py
  - tests/test_position/test_delta_validator.py
autonomous: true

must_haves:
  truths:
    - "Paper executor simulates order fills using current market prices from TickerService"
    - "Live executor delegates to exchange client for real order placement"
    - "Both executors implement the same Executor ABC -- strategy code is identical regardless of mode (PAPR-02)"
    - "Position manager tracks open positions with both spot and perp legs"
    - "Delta validator detects drift between spot and perp quantities and reports tolerance violations (RISK-04)"
    - "Simultaneous spot+perp order placement uses asyncio.gather with timeout and rollback on failure"
  artifacts:
    - path: "src/bot/execution/executor.py"
      provides: "Abstract executor interface"
      exports: ["Executor"]
    - path: "src/bot/execution/paper_executor.py"
      provides: "Paper trading executor with simulated fills"
      exports: ["PaperExecutor"]
    - path: "src/bot/execution/live_executor.py"
      provides: "Real trading executor via exchange client"
      exports: ["LiveExecutor"]
    - path: "src/bot/position/manager.py"
      provides: "Position state tracking and delta-neutral opening/closing"
      exports: ["PositionManager"]
    - path: "src/bot/position/delta_validator.py"
      provides: "Delta neutrality validation"
      exports: ["DeltaValidator"]
  key_links:
    - from: "src/bot/execution/paper_executor.py"
      to: "src/bot/market_data/ticker_service.py"
      via: "fetches current price for simulated fills"
      pattern: "ticker_service.*get_price"
    - from: "src/bot/position/manager.py"
      to: "src/bot/execution/executor.py"
      via: "places orders via executor.place_order"
      pattern: "executor.*place_order"
    - from: "src/bot/position/manager.py"
      to: "src/bot/position/delta_validator.py"
      via: "validates after each position open"
      pattern: "delta_validator.*validate|check_delta"
    - from: "src/bot/position/manager.py"
      to: "asyncio.gather"
      via: "simultaneous spot+perp placement"
      pattern: "asyncio\\.gather"
---

<objective>
Implement the swappable executor pattern (paper and live), position manager with simultaneous spot+perp order placement, and delta neutrality validator.

Purpose: This is the execution core -- EXEC-01 (delta-neutral positions), PAPR-01 (paper mode), PAPR-02 (identical code path), and RISK-04 (delta validation). The swappable executor is the architectural backbone that lets paper and live trading share 100% of strategy logic.

Output: Working paper and live executors, position manager that opens/closes delta-neutral positions atomically, and delta validator that checks position balance.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-trading-engine/01-RESEARCH.md
@.planning/phases/01-core-trading-engine/01-02-SUMMARY.md
@.planning/phases/01-core-trading-engine/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement executor ABC, paper executor, and live executor</name>
  <files>
    src/bot/execution/executor.py
    src/bot/execution/paper_executor.py
    src/bot/execution/live_executor.py
    src/bot/risk/manager.py
    tests/test_execution/__init__.py
    tests/test_execution/test_paper_executor.py
  </files>
  <action>
    **execution/executor.py** -- Abstract base class:
    ```python
    class Executor(ABC):
        @abstractmethod
        async def place_order(self, request: OrderRequest) -> OrderResult: ...
        @abstractmethod
        async def cancel_order(self, order_id: str, symbol: str, category: str = "linear") -> bool: ...
    ```
    Use `OrderRequest` and `OrderResult` from `bot.models`.

    **execution/paper_executor.py** -- Simulated execution:
    - Constructor takes `TickerService` and `FeeSettings`.
    - `place_order(request)`:
      1. Get current price from `ticker_service.get_price(request.symbol)`.
      2. If price is None or stale (>60s), raise `PriceUnavailableError`.
      3. Apply simulated slippage: `fill_price = price * (1 + Decimal("0.0005"))` for buys, `price * (1 - Decimal("0.0005"))` for sells (0.05% slippage simulation).
      4. Calculate fee: `request.quantity * fill_price * fee_rate` (use spot_taker for category="spot", perp_taker for category="linear").
      5. Track virtual balance changes internally: deduct cost for buys, add proceeds for sells.
      6. Return `OrderResult` with `is_simulated=True`, unique `paper_{uuid4().hex[:12]}` order_id.
    - `cancel_order()`: Always returns True (paper orders are instant-fill market orders).
    - `get_virtual_balance() -> dict[str, Decimal]`: returns current virtual balances.
    - `set_initial_balance(currency: str, amount: Decimal)`: set starting virtual balance.

    **execution/live_executor.py** -- Real execution:
    - Constructor takes `ExchangeClient` (from Plan 02).
    - `place_order(request)`:
      1. Call `exchange_client.create_order(symbol, type, side, amount, price, params={'category': request.category})`.
      2. Parse ccxt order result into `OrderResult` with `is_simulated=False`.
      3. All amounts converted via `Decimal(str(value))` -- never direct float.
    - `cancel_order()`: Delegates to exchange client.

    **risk/manager.py** -- Pre-trade risk checks (simple for Phase 1):
    - `RiskManager` takes `TradingSettings`.
    - `check_can_open(position_size_usd: Decimal) -> tuple[bool, str]`: checks if position_size <= max_position_size_usd. Returns (True, "") or (False, "reason").
    - This is a placeholder for Phase 2's comprehensive risk management (RISK-01 through RISK-05). Phase 1 only needs basic size check.

    **tests/test_execution/test_paper_executor.py**:
    - Test paper executor returns simulated fill with correct fee calculation.
    - Test paper executor applies slippage in correct direction (higher for buys, lower for sells).
    - Test paper executor raises error when price is unavailable.
    - Test paper executor tracks virtual balance changes.
    - Test that `is_simulated=True` on all paper results.
    - Mock TickerService to return controlled prices.
  </action>
  <verify>
    Run: `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && python -m pytest tests/test_execution/ -v`
    All tests pass.
    Run: `python -c "
from bot.execution.paper_executor import PaperExecutor
from bot.execution.live_executor import LiveExecutor
from bot.execution.executor import Executor
assert issubclass(PaperExecutor, Executor)
assert issubclass(LiveExecutor, Executor)
print('Executor pattern OK')
"`
  </verify>
  <done>
    PaperExecutor simulates fills using TickerService prices with slippage and fees. LiveExecutor delegates to exchange client. Both implement Executor ABC. Paper executor tracks virtual balances. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement position manager and delta neutrality validator</name>
  <files>
    src/bot/position/manager.py
    src/bot/position/delta_validator.py
    tests/test_position/test_manager.py
    tests/test_position/test_delta_validator.py
  </files>
  <action>
    **position/delta_validator.py** -- Validates delta neutrality:
    - `DeltaValidator` takes `TradingSettings` (for `delta_drift_tolerance`).
    - `validate(spot_qty: Decimal, perp_qty: Decimal) -> DeltaStatus`:
      1. Calculate `drift_pct = abs(spot_qty - perp_qty) / max(spot_qty, perp_qty)` if max > 0, else Decimal("0").
      2. `is_within_tolerance = drift_pct <= settings.delta_drift_tolerance`.
      3. Return `DeltaStatus` with all fields populated.
    - `validate_position(position: Position, current_spot_qty: Decimal, current_perp_qty: Decimal) -> DeltaStatus`:
      - Wraps `validate()` with position_id.

    **position/manager.py** -- Manages position lifecycle:
    - `PositionManager` takes `Executor`, `PositionSizer`, `FeeCalculator`, `DeltaValidator`, and `TickerService`.
    - `_positions: dict[str, Position]` -- open positions keyed by position id.
    - `_lock: asyncio.Lock` -- protects concurrent position modifications.

    - `async open_position(spot_symbol, perp_symbol, available_balance, spot_instrument, perp_instrument) -> Position`:
      1. Get current price from TickerService.
      2. Calculate quantity via PositionSizer.calculate_matching_quantity().
      3. If quantity is None (below minimums), raise `InsufficientSizeError`.
      4. Create spot OrderRequest (BUY, MARKET, category="spot") and perp OrderRequest (SELL, MARKET, category="linear").
      5. Execute both simultaneously: `asyncio.gather(executor.place_order(spot_order), executor.place_order(perp_order))` wrapped in `asyncio.wait_for(timeout=settings.trading.order_timeout_seconds)`.
      6. On timeout: log error, attempt to cancel any pending orders, raise `DeltaHedgeTimeout`.
      7. On partial failure: if one succeeds and other fails, attempt to reverse the successful leg, raise `DeltaHedgeError`.
      8. Validate delta: call `delta_validator.validate(spot_result.filled_qty, perp_result.filled_qty)`.
      9. If delta exceeds tolerance: close both legs immediately, raise `DeltaDriftExceeded`.
      10. Calculate total entry fee: `spot_result.fee + perp_result.fee`.
      11. Create `Position` object, store in `_positions`, return it.

    - `async close_position(position_id: str) -> tuple[OrderResult, OrderResult]`:
      1. Look up position, remove from `_positions`.
      2. Create spot SELL and perp BUY (close short) orders.
      3. Execute simultaneously with same gather/timeout pattern.
      4. Return both results.

    - `get_open_positions() -> list[Position]`: return list of open positions.
    - `get_position(position_id: str) -> Position | None`: get specific position.

    Define custom exceptions in a new `src/bot/exceptions.py` (or at top of manager.py):
    - `DeltaHedgeTimeout`, `DeltaHedgeError`, `DeltaDriftExceeded`, `InsufficientSizeError`, `PriceUnavailableError`

    **tests/test_position/test_delta_validator.py**:
    - Test equal quantities -> within tolerance, drift=0.
    - Test 1% drift -> within 2% tolerance.
    - Test 3% drift -> exceeds 2% tolerance.
    - Test zero quantities -> handled gracefully.

    **tests/test_position/test_manager.py**:
    - Test `open_position` creates position with both legs via mocked executor.
    - Test `open_position` validates delta after fills.
    - Test `close_position` creates reverse orders.
    - Test simultaneous execution uses asyncio.gather (verify both orders placed).
    - Mock executor, position sizer, fee calculator, ticker service.
  </action>
  <verify>
    Run: `cd /Users/luckleineschaars/repos/funding-rate-arbitrage && python -m pytest tests/test_position/ -v`
    All tests pass.
    Run: `python -c "
from bot.position.manager import PositionManager
from bot.position.delta_validator import DeltaValidator
print('Position manager and delta validator import OK')
"`
  </verify>
  <done>
    PositionManager opens/closes delta-neutral positions with simultaneous spot+perp execution. DeltaValidator checks drift against tolerance. Rollback logic handles partial failures. Tests verify the full lifecycle with mocked dependencies.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_execution/ tests/test_position/ -v` -- all tests pass
2. PaperExecutor and LiveExecutor both subclass Executor ABC (PAPR-02 verified)
3. Paper executor uses TickerService for prices, not direct exchange calls
4. Position manager uses asyncio.gather for simultaneous spot+perp placement (EXEC-01)
5. Delta validator correctly identifies drift violations (RISK-04)
6. Rollback logic exists for partial failures (timeout, one-sided fill)
7. All monetary values use Decimal
</verification>

<success_criteria>
- Swappable executor pattern works: paper and live share identical interface (PAPR-02)
- Paper executor simulates fills with realistic prices, slippage, and fees (PAPR-01)
- Position manager opens delta-neutral positions atomically (EXEC-01)
- Delta validator catches drift violations (RISK-04)
- Position lifecycle (open, track, close) works end-to-end in tests
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-trading-engine/01-04-SUMMARY.md`
</output>
