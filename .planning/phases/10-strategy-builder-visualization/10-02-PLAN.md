---
phase: 10-strategy-builder-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bot/backtest/presets.py
  - src/bot/dashboard/routes/api.py
  - src/bot/dashboard/templates/partials/backtest_form.html
  - src/bot/dashboard/templates/backtest.html
autonomous: true

must_haves:
  truths:
    - "User can see three preset buttons (Conservative, Balanced, Aggressive) above the advanced parameters section"
    - "Clicking a preset button pre-fills the backtest form with the preset's parameter values"
    - "The strategy mode dropdown updates to match the preset (simple for conservative, composite for balanced/aggressive)"
    - "User can still manually override individual parameters after applying a preset"
  artifacts:
    - path: "src/bot/backtest/presets.py"
      provides: "STRATEGY_PRESETS dict with conservative, balanced, aggressive configurations"
      contains: "STRATEGY_PRESETS"
    - path: "src/bot/dashboard/routes/api.py"
      provides: "GET /api/backtest/presets endpoint"
      contains: "/backtest/presets"
    - path: "src/bot/dashboard/templates/partials/backtest_form.html"
      provides: "Preset button panel above advanced parameters"
      contains: "preset"
    - path: "src/bot/dashboard/templates/backtest.html"
      provides: "applyPreset() JS function wiring preset buttons to form inputs"
      contains: "applyPreset"
  key_links:
    - from: "src/bot/dashboard/templates/backtest.html"
      to: "/api/backtest/presets"
      via: "fetch GET on page load to populate preset definitions"
      pattern: "api/backtest/presets"
    - from: "src/bot/dashboard/routes/api.py"
      to: "src/bot/backtest/presets.py"
      via: "import STRATEGY_PRESETS"
      pattern: "STRATEGY_PRESETS"
---

<objective>
Add strategy preset templates (conservative, balanced, aggressive) that pre-fill backtest form parameters with a single click.

Purpose: Satisfies STRT-03 (preset strategy templates that pre-fill parameters), reducing the parameter-tuning burden for new users.
Output: Preset definitions module, API endpoint, and preset button UI on backtest form.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/bot/backtest/models.py
@src/bot/dashboard/routes/api.py
@src/bot/dashboard/templates/partials/backtest_form.html
@src/bot/dashboard/templates/backtest.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strategy presets module and API endpoint</name>
  <files>src/bot/backtest/presets.py, src/bot/dashboard/routes/api.py</files>
  <action>
  Create `src/bot/backtest/presets.py` with the static preset definitions:

  ```python
  """Strategy preset configurations for backtest parameter pre-fill.

  Three preset levels provide quick parameter configuration:
  - Conservative: Simple strategy with high thresholds (fewer but safer trades)
  - Balanced: Composite strategy with moderate thresholds
  - Aggressive: Composite strategy with low thresholds (more trades, higher risk)

  Presets apply ONLY to the backtest form. They pre-fill parameters for
  experimentation. They do NOT affect live trading parameters.
  """

  from decimal import Decimal

  STRATEGY_PRESETS: dict[str, dict] = {
      "conservative": {
          "label": "Conservative",
          "description": "Fewer trades, higher thresholds. Simple strategy with strict entry/exit.",
          "strategy_mode": "simple",
          "params": {
              "min_funding_rate": "0.0005",
              "exit_funding_rate": "0.0002",
          },
      },
      "balanced": {
          "label": "Balanced",
          "description": "Moderate entry/exit. Composite strategy with balanced signal weights.",
          "strategy_mode": "composite",
          "params": {
              "entry_threshold": "0.35",
              "exit_threshold": "0.2",
              "weight_rate_level": "0.35",
              "weight_trend": "0.25",
              "weight_persistence": "0.25",
              "weight_basis": "0.15",
          },
      },
      "aggressive": {
          "label": "Aggressive",
          "description": "More trades, lower thresholds. Composite strategy favoring rate level.",
          "strategy_mode": "composite",
          "params": {
              "entry_threshold": "0.25",
              "exit_threshold": "0.15",
              "weight_rate_level": "0.40",
              "weight_trend": "0.20",
              "weight_persistence": "0.25",
              "weight_basis": "0.15",
          },
      },
  }
  ```

  All values are strings (not Decimal) since they go to JSON and the form fields accept string values. The API converts them as needed.

  In `api.py`, add a GET endpoint:

  ```python
  from bot.backtest.presets import STRATEGY_PRESETS

  @router.get("/backtest/presets")
  async def get_strategy_presets(request: Request) -> JSONResponse:
      """Phase 10: Return available strategy preset configurations."""
      return JSONResponse(content=STRATEGY_PRESETS)
  ```

  Place this endpoint in the backtest section of api.py, near the other `/backtest/*` routes.
  </action>
  <verify>
  Run `python -c "from bot.backtest.presets import STRATEGY_PRESETS; print(len(STRATEGY_PRESETS), 'presets'); print(list(STRATEGY_PRESETS.keys()))"` -- should print 3 presets and the key names.
  Run `python -c "from bot.dashboard.routes.api import router; print('OK')"` to verify import works.
  </verify>
  <done>STRATEGY_PRESETS dict exists in presets.py with 3 presets (conservative, balanced, aggressive). GET /api/backtest/presets endpoint returns the preset definitions as JSON.</done>
</task>

<task type="auto">
  <name>Task 2: Preset buttons UI and form pre-fill logic</name>
  <files>src/bot/dashboard/templates/partials/backtest_form.html, src/bot/dashboard/templates/backtest.html</files>
  <action>
  **In `backtest_form.html`**, add a preset button panel between the "Strategy Mode" row and the "Run Mode" section. Place it right after the closing `</div>` of the `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4` div:

  ```html
  <!-- Strategy Presets -->
  <div class="mt-4">
    <label class="block text-xs text-gray-400 mb-2">Strategy Presets</label>
    <div class="flex items-center gap-3" id="preset-buttons">
      <button type="button" data-preset="conservative"
              class="px-4 py-1.5 text-sm rounded border border-dash-border bg-dash-bg text-gray-300 hover:border-green-500 hover:text-green-400 transition-colors">
        Conservative
      </button>
      <button type="button" data-preset="balanced"
              class="px-4 py-1.5 text-sm rounded border border-dash-border bg-dash-bg text-gray-300 hover:border-blue-500 hover:text-blue-400 transition-colors">
        Balanced
      </button>
      <button type="button" data-preset="aggressive"
              class="px-4 py-1.5 text-sm rounded border border-dash-border bg-dash-bg text-gray-300 hover:border-red-500 hover:text-red-400 transition-colors">
        Aggressive
      </button>
      <span class="text-xs text-gray-500 italic" id="preset-active-label"></span>
    </div>
  </div>
  ```

  **In `backtest.html` script section**, add preset logic:

  1. At the top of the IIFE, add a variable to hold preset data: `let presetData = {};`
  2. Fetch presets on page load:
     ```javascript
     fetch('/api/backtest/presets')
         .then(function(resp) { return resp.json(); })
         .then(function(data) { presetData = data; })
         .catch(function() { /* presets optional, degrade gracefully */ });
     ```
  3. Add `applyPreset(presetName)` function:
     ```javascript
     function applyPreset(presetName) {
         var preset = presetData[presetName];
         if (!preset) return;

         // Set strategy mode dropdown
         document.getElementById('bt-strategy').value = preset.strategy_mode;

         // Clear all advanced parameter fields first
         var advancedFields = ['min_funding_rate', 'entry_threshold', 'exit_threshold',
                               'exit_funding_rate', 'weight_rate_level', 'weight_trend',
                               'weight_persistence', 'weight_basis'];
         advancedFields.forEach(function(field) {
             var input = form.querySelector('[name="' + field + '"]');
             if (input) input.value = '';
         });

         // Fill preset params
         Object.keys(preset.params).forEach(function(key) {
             var input = form.querySelector('[name="' + key + '"]');
             if (input) input.value = preset.params[key];
         });

         // Show active preset label
         var label = document.getElementById('preset-active-label');
         label.textContent = preset.label + ' applied';

         // Highlight active button
         document.querySelectorAll('[data-preset]').forEach(function(btn) {
             btn.classList.remove('border-green-500', 'border-blue-500', 'border-red-500', 'text-green-400', 'text-blue-400', 'text-red-400');
         });
         var activeBtn = document.querySelector('[data-preset="' + presetName + '"]');
         if (presetName === 'conservative') {
             activeBtn.classList.add('border-green-500', 'text-green-400');
         } else if (presetName === 'balanced') {
             activeBtn.classList.add('border-blue-500', 'text-blue-400');
         } else {
             activeBtn.classList.add('border-red-500', 'text-red-400');
         }
     }
     ```
  4. Wire preset button click handlers:
     ```javascript
     document.querySelectorAll('[data-preset]').forEach(function(btn) {
         btn.addEventListener('click', function() {
             applyPreset(this.dataset.preset);
         });
     });
     ```

  Note: Presets do NOT auto-open the "Advanced Parameters" details section -- the user can open it to see/modify the filled values if desired.
  </action>
  <verify>
  1. Visit `/backtest` and verify three preset buttons appear (Conservative, Balanced, Aggressive).
  2. Click "Conservative" and verify strategy mode changes to "Simple" and min_funding_rate/exit_funding_rate fields populate in Advanced Parameters.
  3. Click "Balanced" and verify strategy mode changes to "Composite" and composite fields populate.
  4. Click "Aggressive" and verify lower thresholds are filled compared to Balanced.
  5. Verify the active preset label updates and the button highlights.
  </verify>
  <done>Three preset buttons appear on the backtest form. Clicking a preset pre-fills the strategy mode and all relevant parameters. User can still manually adjust values after applying a preset.</done>
</task>

</tasks>

<verification>
1. `python -c "from bot.backtest.presets import STRATEGY_PRESETS; print('OK')"` succeeds
2. GET /api/backtest/presets returns JSON with 3 preset definitions
3. Backtest form shows Conservative, Balanced, Aggressive buttons
4. Clicking a preset fills form fields and updates strategy mode dropdown
5. User can modify filled values after applying a preset
</verification>

<success_criteria>
- STRATEGY_PRESETS dict in presets.py with 3 presets (conservative, balanced, aggressive)
- GET /api/backtest/presets endpoint returns preset definitions
- Three clickable preset buttons on the backtest form above advanced params
- Clicking a preset pre-fills strategy_mode and all relevant parameter fields
- Active preset is visually indicated with a colored border and label
</success_criteria>

<output>
After completion, create `.planning/phases/10-strategy-builder-visualization/10-02-SUMMARY.md`
</output>
