{% extends "base.html" %}

{% block title %}Backtest | Funding Rate Arbitrage{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <h2 class="text-2xl font-bold text-white">Backtest Engine</h2>

    <!-- Configuration Form -->
    {% include "partials/backtest_form.html" %}

    <!-- Error Display -->
    <div id="backtest-error" class="hidden bg-red-900/50 border border-red-700 rounded-lg p-4">
        <p class="text-red-300 text-sm" id="error-message"></p>
    </div>

    <!-- Results Area (hidden until backtest completes) -->
    <div id="backtest-results" class="hidden space-y-6">
        <!-- Summary Metrics Cards -->
        <div id="metrics-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Filled by JS after backtest completes -->
        </div>

        <!-- Equity Curve Chart -->
        {% include "partials/equity_curve.html" %}

        <!-- Trade Statistics (shown for single backtest) -->
        {% include "partials/trade_stats.html" %}

        <!-- Trade Log (shown for single backtest) -->
        {% include "partials/trade_log.html" %}

        <!-- P&L Distribution Histogram (shown for single backtest) -->
        {% include "partials/pnl_histogram.html" %}

        <!-- Comparison Table (shown for compare mode) -->
        <div id="comparison-section" class="hidden">
            <div class="bg-dash-card rounded-lg border border-dash-border p-4">
                <h3 class="text-white font-semibold mb-3">Strategy Comparison: Simple vs Composite</h3>
                <table id="comparison-table" class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-dash-border">
                            <th class="text-left py-2">Metric</th>
                            <th class="text-right py-2">Simple (v1.0)</th>
                            <th class="text-right py-2">Composite (v1.1)</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Parameter Heatmap (shown for sweep mode) -->
        {% include "partials/param_heatmap.html" %}

        <!-- Multi-Pair Comparison Table (shown for multi mode) -->
        <div id="multi-pair-section" class="hidden">
            <div class="bg-dash-card rounded-lg border border-dash-border p-4">
                <h3 class="text-white font-semibold mb-1">Multi-Pair Results</h3>
                <p class="text-sm text-gray-400 mb-3" id="multi-pair-summary"></p>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-dash-border">
                            <th class="text-left py-2 px-2">Pair</th>
                            <th class="text-right py-2 px-2">Net P&L</th>
                            <th class="text-right py-2 px-2">Sharpe</th>
                            <th class="text-right py-2 px-2">Win Rate</th>
                            <th class="text-right py-2 px-2">Trades</th>
                            <th class="text-right py-2 px-2">Funding</th>
                            <th class="text-right py-2 px-2">Fees</th>
                        </tr>
                    </thead>
                    <tbody id="multi-pair-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="backtest-loading" class="hidden text-center py-12">
        <div class="animate-spin inline-block w-8 h-8 border-2 border-gray-500 border-t-green-500 rounded-full"></div>
        <p class="text-gray-400 mt-3" id="loading-message">Running backtest...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    const btn = document.getElementById('btn-run-backtest');
    const form = document.getElementById('backtest-form');
    const loadingEl = document.getElementById('backtest-loading');
    const loadingMsg = document.getElementById('loading-message');
    const resultsEl = document.getElementById('backtest-results');
    const errorEl = document.getElementById('backtest-error');
    const errorMsg = document.getElementById('error-message');
    const metricsCards = document.getElementById('metrics-cards');
    const comparisonSection = document.getElementById('comparison-section');
    const comparisonBody = document.getElementById('comparison-body');
    const heatmapSection = document.getElementById('heatmap-section');
    const equitySection = document.getElementById('equity-curve-section');
    const tradeLogSection = document.getElementById('trade-log-section');
    const tradeLogBody = document.getElementById('trade-log-body');
    const tradeLogEmpty = document.getElementById('trade-log-empty');
    const tradeStatsSection = document.getElementById('trade-stats-section');
    const tradeStatsCards = document.getElementById('trade-stats-cards');
    const pnlHistSection = document.getElementById('pnl-histogram-section');
    const multiPairPanel = document.getElementById('multi-pair-panel');
    const multiPairSection = document.getElementById('multi-pair-section');
    const multiPairSummary = document.getElementById('multi-pair-summary');
    const multiPairBody = document.getElementById('multi-pair-body');

    let pollInterval = null;
    let presetData = {};

    // Fetch strategy presets on page load (optional, degrades gracefully)
    fetch('/api/backtest/presets')
        .then(function(resp) { return resp.json(); })
        .then(function(data) { presetData = data; })
        .catch(function() { /* presets optional, degrade gracefully */ });

    /**
     * Apply a strategy preset to the backtest form fields.
     * Sets strategy mode, clears all advanced fields, fills preset params,
     * highlights the active button.
     * @param {string} presetName - Preset key ("conservative", "balanced", "aggressive").
     */
    function applyPreset(presetName) {
        var preset = presetData[presetName];
        if (!preset) return;

        // Set strategy mode dropdown
        document.getElementById('bt-strategy').value = preset.strategy_mode;

        // Clear all advanced parameter fields first
        var advancedFields = ['min_funding_rate', 'entry_threshold', 'exit_threshold',
                              'exit_funding_rate', 'weight_rate_level', 'weight_trend',
                              'weight_persistence', 'weight_basis'];
        advancedFields.forEach(function(field) {
            var input = form.querySelector('[name="' + field + '"]');
            if (input) input.value = '';
        });

        // Fill preset params
        Object.keys(preset.params).forEach(function(key) {
            var input = form.querySelector('[name="' + key + '"]');
            if (input) input.value = preset.params[key];
        });

        // Show active preset label
        var label = document.getElementById('preset-active-label');
        label.textContent = preset.label + ' applied';

        // Highlight active button
        document.querySelectorAll('[data-preset]').forEach(function(btn) {
            btn.classList.remove('border-green-500', 'border-blue-500', 'border-red-500', 'text-green-400', 'text-blue-400', 'text-red-400');
        });
        var activeBtn = document.querySelector('[data-preset="' + presetName + '"]');
        if (presetName === 'conservative') {
            activeBtn.classList.add('border-green-500', 'text-green-400');
        } else if (presetName === 'balanced') {
            activeBtn.classList.add('border-blue-500', 'text-blue-400');
        } else {
            activeBtn.classList.add('border-red-500', 'text-red-400');
        }
    }

    // Wire preset button click handlers
    document.querySelectorAll('[data-preset]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            applyPreset(this.dataset.preset);
        });
    });

    // Show/hide multi-pair panel based on run mode selection
    form.querySelectorAll('input[name="run_mode"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            multiPairPanel.classList.toggle('hidden', this.value !== 'multi');
        });
    });

    // Wire select-all / deselect-all buttons for multi-pair checkboxes
    var btnSelectAll = document.getElementById('btn-select-all');
    var btnDeselectAll = document.getElementById('btn-deselect-all');
    if (btnSelectAll) {
        btnSelectAll.addEventListener('click', function() {
            form.querySelectorAll('input[name="multi_symbols"]').forEach(function(cb) { cb.checked = true; });
        });
    }
    if (btnDeselectAll) {
        btnDeselectAll.addEventListener('click', function() {
            form.querySelectorAll('input[name="multi_symbols"]').forEach(function(cb) { cb.checked = false; });
        });
    }

    /**
     * Collect form values into a JSON-serializable object.
     * @returns {Object} Form data with symbol, dates, strategy, run mode, and overrides.
     */
    function getFormData() {
        const data = {
            symbol: document.getElementById('bt-symbol').value,
            start_date: document.getElementById('bt-start-date').value,
            end_date: document.getElementById('bt-end-date').value,
            strategy_mode: document.getElementById('bt-strategy').value,
        };

        // Get run mode
        const runMode = form.querySelector('input[name="run_mode"]:checked');
        data.run_mode = runMode ? runMode.value : 'single';

        // For multi mode, collect checked symbols instead of single symbol
        if (data.run_mode === 'multi') {
            var checked = [];
            form.querySelectorAll('input[name="multi_symbols"]:checked').forEach(function(cb) {
                checked.push(cb.value);
            });
            data.symbols = checked;
        }

        // Collect optional numeric overrides (only if user entered a value)
        const optionalFields = [
            'min_funding_rate', 'entry_threshold', 'exit_threshold',
            'exit_funding_rate', 'weight_rate_level', 'weight_trend',
            'weight_persistence', 'weight_basis'
        ];
        optionalFields.forEach(field => {
            const input = form.querySelector('[name="' + field + '"]');
            if (input && input.value !== '') {
                data[field] = input.value;
            }
        });

        return data;
    }

    /**
     * Validate form inputs before submission.
     * @param {Object} data - Form data object.
     * @returns {string|null} Error message or null if valid.
     */
    function validateForm(data) {
        if (data.run_mode === 'multi') {
            if (!data.symbols || data.symbols.length === 0) return 'Please select at least one pair for multi-pair backtest.';
        } else {
            if (!data.symbol) return 'Please enter a symbol.';
        }
        if (!data.start_date) return 'Please select a start date.';
        if (!data.end_date) return 'Please select an end date.';
        if (data.start_date >= data.end_date) return 'End date must be after start date.';
        return null;
    }

    /**
     * Show an error message to the user.
     * @param {string} msg - Error text to display.
     */
    function showError(msg) {
        errorMsg.textContent = msg;
        errorEl.classList.remove('hidden');
        loadingEl.classList.add('hidden');
    }

    /** Hide all result sections and reset state. */
    function resetResults() {
        resultsEl.classList.add('hidden');
        errorEl.classList.add('hidden');
        comparisonSection.classList.add('hidden');
        heatmapSection.classList.add('hidden');
        tradeLogSection.classList.add('hidden');
        tradeStatsSection.classList.add('hidden');
        pnlHistSection.classList.add('hidden');
        multiPairSection.classList.add('hidden');
        metricsCards.innerHTML = '';
        comparisonBody.innerHTML = '';
        tradeLogBody.innerHTML = '';
        tradeStatsCards.innerHTML = '';
        multiPairBody.innerHTML = '';
        multiPairSummary.textContent = '';
    }

    /**
     * Determine the API endpoint URL based on run mode.
     * @param {string} runMode - "single", "compare", or "sweep".
     * @returns {string} API endpoint path.
     */
    function getEndpoint(runMode) {
        if (runMode === 'compare') return '/api/backtest/compare';
        if (runMode === 'sweep') return '/api/backtest/sweep';
        if (runMode === 'multi') return '/api/backtest/multi';
        return '/api/backtest/run';
    }

    /**
     * Create a metric card element for the results display.
     * @param {string} label - Metric name.
     * @param {string} value - Formatted value string.
     * @param {string} colorClass - Tailwind text color class.
     * @returns {string} HTML string for the card.
     */
    function metricCard(label, value, colorClass) {
        return '<div class="bg-dash-card rounded-lg border border-dash-border p-3">' +
               '<p class="text-xs text-gray-400 mb-1">' + label + '</p>' +
               '<p class="text-lg font-semibold ' + (colorClass || 'text-white') + '">' + value + '</p>' +
               '</div>';
    }

    /**
     * Format a numeric string as a dollar value.
     * @param {string} val - Numeric string.
     * @returns {string} Formatted dollar string.
     */
    function fmtDollar(val) {
        const n = parseFloat(val);
        const sign = n >= 0 ? '+' : '';
        return sign + '$' + n.toFixed(2);
    }

    /**
     * Format a numeric string as a percentage.
     * @param {string|null} val - Numeric string or null.
     * @returns {string} Formatted percentage or "N/A".
     */
    function fmtPercent(val) {
        if (val === null || val === undefined) return 'N/A';
        return (parseFloat(val) * 100).toFixed(1) + '%';
    }

    /**
     * Format a numeric string to 2 decimal places.
     * @param {string|null} val - Numeric string or null.
     * @returns {string} Formatted number or "N/A".
     */
    function fmtNum(val) {
        if (val === null || val === undefined) return 'N/A';
        return parseFloat(val).toFixed(2);
    }

    /**
     * Format a millisecond timestamp as a short date+time string.
     * @param {number} ms - Timestamp in milliseconds.
     * @returns {string} Formatted date string like "Jan 5 02:30 PM".
     */
    function fmtDate(ms) {
        var d = new Date(ms);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
               d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    /**
     * Display metrics for a single backtest result.
     * @param {Object} metrics - Metrics object from BacktestResult.
     */
    function displaySingleMetrics(metrics) {
        const pnl = parseFloat(metrics.net_pnl);
        const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';

        metricsCards.innerHTML =
            metricCard('Net P&L', fmtDollar(metrics.net_pnl), pnlColor) +
            metricCard('Sharpe Ratio', fmtNum(metrics.sharpe_ratio), 'text-white') +
            metricCard('Max Drawdown', metrics.max_drawdown !== null ? fmtDollar(metrics.max_drawdown) : 'N/A', 'text-yellow-400') +
            metricCard('Win Rate', fmtPercent(metrics.win_rate), 'text-white') +
            metricCard('Total Trades', metrics.total_trades, 'text-white') +
            metricCard('Total Funding', fmtDollar(metrics.total_funding), 'text-blue-400') +
            metricCard('Total Fees', fmtDollar(metrics.total_fees), 'text-orange-400') +
            metricCard('Duration', metrics.duration_days + ' days', 'text-white');
    }

    /**
     * Display the trade log table with expandable detail rows.
     * @param {Array|null} trades - Array of trade objects from result.trades.
     */
    function displayTradeLog(trades) {
        if (!trades || trades.length === 0) {
            tradeLogSection.classList.remove('hidden');
            tradeLogBody.innerHTML = '';
            tradeLogEmpty.classList.remove('hidden');
            return;
        }

        tradeLogSection.classList.remove('hidden');
        tradeLogEmpty.classList.add('hidden');

        var html = '';
        for (var i = 0; i < trades.length; i++) {
            var t = trades[i];
            var pnl = parseFloat(t.net_pnl);
            var pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
            var badge = t.is_win
                ? '<span class="text-green-400 font-medium">Win</span>'
                : '<span class="text-red-400 font-medium">Loss</span>';

            // Summary row (clickable)
            html += '<tr class="border-b border-dash-border hover:bg-gray-800/50 cursor-pointer" onclick="this.nextElementSibling.classList.toggle(\'hidden\')">';
            html += '<td class="py-2 px-2 text-gray-300">' + t.trade_number + '</td>';
            html += '<td class="py-2 px-2 text-gray-300 text-xs">' + fmtDate(t.entry_time_ms) + '</td>';
            html += '<td class="py-2 px-2 text-gray-300 text-xs">' + fmtDate(t.exit_time_ms) + '</td>';
            html += '<td class="py-2 px-2 text-right font-mono ' + pnlColor + '">' + fmtDollar(t.net_pnl) + '</td>';
            html += '<td class="py-2 px-2 text-right text-gray-300">' + t.holding_periods + '</td>';
            html += '<td class="py-2 px-2">' + badge + '</td>';
            html += '</tr>';

            // Detail row (hidden by default)
            html += '<tr class="hidden border-b border-dash-border bg-gray-900/30">';
            html += '<td colspan="6" class="py-3 px-4">';
            html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">';
            html += '<div><span class="text-gray-500">Symbol</span><br><span class="text-gray-300">' + t.symbol + '</span></div>';
            html += '<div><span class="text-gray-500">Entry Price</span><br><span class="text-gray-300">$' + parseFloat(t.entry_price).toFixed(2) + '</span></div>';
            html += '<div><span class="text-gray-500">Exit Price</span><br><span class="text-gray-300">$' + parseFloat(t.exit_price).toFixed(2) + '</span></div>';
            html += '<div><span class="text-gray-500">Quantity</span><br><span class="text-gray-300">' + parseFloat(t.quantity).toFixed(4) + '</span></div>';
            html += '<div><span class="text-gray-500">Funding Collected</span><br><span class="text-blue-400">' + fmtDollar(t.funding_collected) + '</span></div>';
            html += '<div><span class="text-gray-500">Entry Fee</span><br><span class="text-orange-400">' + fmtDollar(t.entry_fee) + '</span></div>';
            html += '<div><span class="text-gray-500">Exit Fee</span><br><span class="text-orange-400">' + fmtDollar(t.exit_fee) + '</span></div>';
            html += '<div><span class="text-gray-500">Total Fees</span><br><span class="text-orange-400">' + fmtDollar(t.total_fees) + '</span></div>';
            html += '</div>';
            html += '</td>';
            html += '</tr>';
        }

        tradeLogBody.innerHTML = html;
    }

    /**
     * Display trade statistics summary cards.
     * @param {Object|null} tradeStats - Trade stats object from result.trade_stats.
     */
    function displayTradeStats(tradeStats) {
        if (!tradeStats || tradeStats.total_trades === 0) {
            tradeStatsSection.classList.add('hidden');
            return;
        }

        tradeStatsSection.classList.remove('hidden');

        tradeStatsCards.innerHTML =
            metricCard('Total Trades', tradeStats.total_trades, 'text-white') +
            metricCard('Win Rate', fmtPercent(tradeStats.win_rate), 'text-white') +
            metricCard('Winning / Losing', tradeStats.winning_trades + ' / ' + tradeStats.losing_trades, 'text-white') +
            metricCard('Avg Win', tradeStats.avg_win ? fmtDollar(tradeStats.avg_win) : 'N/A', 'text-green-400') +
            metricCard('Avg Loss', tradeStats.avg_loss ? '-$' + parseFloat(tradeStats.avg_loss).toFixed(2) : 'N/A', 'text-red-400') +
            metricCard('Best Trade', tradeStats.best_trade ? fmtDollar(tradeStats.best_trade) : 'N/A', 'text-green-400') +
            metricCard('Worst Trade', tradeStats.worst_trade ? fmtDollar(tradeStats.worst_trade) : 'N/A', 'text-red-400') +
            metricCard('Avg Holding', tradeStats.avg_holding_periods ? parseFloat(tradeStats.avg_holding_periods).toFixed(1) + ' periods' : 'N/A', 'text-white');
    }

    /**
     * Display results for a single backtest.
     * @param {Object} result - BacktestResult.to_dict() output.
     */
    function displaySingleResult(result) {
        displaySingleMetrics(result.metrics);

        // Render equity curve with trade markers
        if (result.equity_curve && result.equity_curve.length > 0) {
            equitySection.classList.remove('hidden');
            renderEquityCurve(result.equity_curve, result.config.strategy_mode + ' strategy', '#22c55e', result.trades);
        } else {
            equitySection.classList.add('hidden');
        }

        // Render P&L histogram
        renderPnlHistogram(result.pnl_histogram);

        comparisonSection.classList.add('hidden');
        heatmapSection.classList.add('hidden');

        displayTradeStats(result.trade_stats);
        displayTradeLog(result.trades);

        resultsEl.classList.remove('hidden');
    }

    /**
     * Display results for a comparison (simple vs composite).
     * @param {Object} result - {simple: BacktestResult, composite: BacktestResult}.
     */
    function displayComparisonResult(result) {
        const simple = result.simple;
        const composite = result.composite;

        // Show composite metrics in cards (primary focus)
        displaySingleMetrics(composite.metrics);

        // Render comparison equity curve
        if (simple.equity_curve.length > 0 || composite.equity_curve.length > 0) {
            equitySection.classList.remove('hidden');
            renderComparisonEquityCurve(simple.equity_curve, composite.equity_curve);
        }

        // Build comparison table
        const rows = [
            ['Net P&L', fmtDollar(simple.metrics.net_pnl), fmtDollar(composite.metrics.net_pnl)],
            ['Sharpe Ratio', fmtNum(simple.metrics.sharpe_ratio), fmtNum(composite.metrics.sharpe_ratio)],
            ['Max Drawdown', simple.metrics.max_drawdown !== null ? fmtDollar(simple.metrics.max_drawdown) : 'N/A', composite.metrics.max_drawdown !== null ? fmtDollar(composite.metrics.max_drawdown) : 'N/A'],
            ['Win Rate', fmtPercent(simple.metrics.win_rate), fmtPercent(composite.metrics.win_rate)],
            ['Total Trades', simple.metrics.total_trades, composite.metrics.total_trades],
            ['Total Funding', fmtDollar(simple.metrics.total_funding), fmtDollar(composite.metrics.total_funding)],
            ['Total Fees', fmtDollar(simple.metrics.total_fees), fmtDollar(composite.metrics.total_fees)],
            ['Duration', simple.metrics.duration_days + ' days', composite.metrics.duration_days + ' days'],
        ];

        comparisonBody.innerHTML = rows.map(function(row) {
            return '<tr class="border-b border-dash-border">' +
                   '<td class="py-2 text-gray-300">' + row[0] + '</td>' +
                   '<td class="text-right py-2 text-gray-200 font-mono text-sm">' + row[1] + '</td>' +
                   '<td class="text-right py-2 text-gray-200 font-mono text-sm">' + row[2] + '</td>' +
                   '</tr>';
        }).join('');

        comparisonSection.classList.remove('hidden');
        heatmapSection.classList.add('hidden');
        tradeLogSection.classList.add('hidden');
        tradeStatsSection.classList.add('hidden');
        pnlHistSection.classList.add('hidden');
        resultsEl.classList.remove('hidden');
    }

    /**
     * Display results for a parameter sweep.
     * @param {Object} result - SweepResult.to_dict() output.
     */
    function displaySweepResult(result) {
        // Show best result metrics in cards
        if (result.results && result.results.length > 0) {
            // Sort by P&L and show best
            const sorted = [...result.results].sort(function(a, b) {
                return parseFloat(b.result.metrics.net_pnl) - parseFloat(a.result.metrics.net_pnl);
            });
            displaySingleMetrics(sorted[0].result.metrics);

            // Render best equity curve if available (with trades if present)
            const bestEquity = sorted[0].result.equity_curve;
            var bestTrades = sorted[0].result.trades || [];
            if (bestEquity && bestEquity.length > 0) {
                equitySection.classList.remove('hidden');
                renderEquityCurve(bestEquity, 'Best params', '#22c55e', bestTrades);
            } else {
                equitySection.classList.add('hidden');
            }
        }

        // Render heatmap
        renderHeatmap(result);
        heatmapSection.classList.remove('hidden');

        comparisonSection.classList.add('hidden');
        tradeLogSection.classList.add('hidden');
        tradeStatsSection.classList.add('hidden');
        pnlHistSection.classList.add('hidden');
        resultsEl.classList.remove('hidden');
    }

    /**
     * Display results for a multi-pair backtest.
     * Shows aggregate summary and comparison table sorted by net P&L.
     * @param {Object} result - MultiPairResult.to_dict() output.
     */
    function displayMultiPairResult(result) {
        // Aggregate summary card
        var profitCount = result.profitable_count;
        var totalCount = result.total_count;
        var successCount = result.successful_count;
        var summaryColor = profitCount > totalCount / 2 ? 'text-green-400' : 'text-yellow-400';

        metricsCards.innerHTML =
            metricCard('Profitable Pairs', profitCount + ' of ' + totalCount, summaryColor) +
            metricCard('Successful Runs', successCount + ' of ' + totalCount, 'text-white') +
            metricCard('Failed Runs', (totalCount - successCount), totalCount - successCount > 0 ? 'text-red-400' : 'text-gray-400');

        multiPairSummary.textContent = profitCount + ' of ' + totalCount + ' pairs profitable';

        // Sort results by net P&L descending (errors at end)
        var sorted = result.results.slice().sort(function(a, b) {
            if (a.metrics && b.metrics) {
                return parseFloat(b.metrics.net_pnl) - parseFloat(a.metrics.net_pnl);
            }
            if (a.metrics) return -1;
            if (b.metrics) return 1;
            return 0;
        });

        // Build table rows
        var html = '';
        for (var i = 0; i < sorted.length; i++) {
            var item = sorted[i];
            if (item.error || !item.metrics) {
                html += '<tr class="border-b border-dash-border">';
                html += '<td class="py-2 px-2 text-gray-300">' + item.symbol + '</td>';
                html += '<td colspan="6" class="py-2 px-2 text-gray-500 italic text-center">' + (item.error || 'No data') + '</td>';
                html += '</tr>';
            } else {
                var m = item.metrics;
                var pnl = parseFloat(m.net_pnl);
                var pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                html += '<tr class="border-b border-dash-border hover:bg-gray-800/50">';
                html += '<td class="py-2 px-2 text-gray-200 font-medium">' + item.symbol + '</td>';
                html += '<td class="py-2 px-2 text-right font-mono ' + pnlColor + '">' + fmtDollar(m.net_pnl) + '</td>';
                html += '<td class="py-2 px-2 text-right text-gray-300 font-mono">' + fmtNum(m.sharpe_ratio) + '</td>';
                html += '<td class="py-2 px-2 text-right text-gray-300">' + fmtPercent(m.win_rate) + '</td>';
                html += '<td class="py-2 px-2 text-right text-gray-300">' + m.total_trades + '</td>';
                html += '<td class="py-2 px-2 text-right text-blue-400 font-mono">' + fmtDollar(m.total_funding) + '</td>';
                html += '<td class="py-2 px-2 text-right text-orange-400 font-mono">' + fmtDollar(m.total_fees) + '</td>';
                html += '</tr>';
            }
        }
        multiPairBody.innerHTML = html;

        // Show multi-pair section, hide other mode-specific sections
        multiPairSection.classList.remove('hidden');
        equitySection.classList.add('hidden');
        comparisonSection.classList.add('hidden');
        heatmapSection.classList.add('hidden');
        tradeLogSection.classList.add('hidden');
        tradeStatsSection.classList.add('hidden');
        pnlHistSection.classList.add('hidden');
        resultsEl.classList.remove('hidden');
    }

    /**
     * Poll the status endpoint for a running backtest task.
     * @param {string} taskId - Task identifier.
     * @param {string} taskType - "backtest", "compare", "sweep", or "multi".
     */
    function pollStatus(taskId, taskType) {
        if (pollInterval) clearInterval(pollInterval);

        pollInterval = setInterval(function() {
            fetch('/api/backtest/status/' + taskId)
                .then(function(resp) { return resp.json(); })
                .then(function(data) {
                    if (data.status === 'running') return;

                    clearInterval(pollInterval);
                    pollInterval = null;
                    loadingEl.classList.add('hidden');
                    btn.disabled = false;

                    if (data.status === 'error') {
                        showError(data.result && data.result.error ? data.result.error : 'Backtest failed with an unknown error.');
                        return;
                    }

                    // Complete
                    if (taskType === 'compare') {
                        displayComparisonResult(data.result);
                    } else if (taskType === 'sweep') {
                        displaySweepResult(data.result);
                    } else if (taskType === 'multi') {
                        displayMultiPairResult(data.result);
                    } else {
                        displaySingleResult(data.result);
                    }
                })
                .catch(function(err) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    loadingEl.classList.add('hidden');
                    btn.disabled = false;
                    showError('Failed to check backtest status: ' + err.message);
                });
        }, 2000);
    }

    /** Handle the Run Backtest button click. */
    btn.addEventListener('click', function() {
        resetResults();

        const data = getFormData();
        const validationError = validateForm(data);
        if (validationError) {
            showError(validationError);
            return;
        }

        const runMode = data.run_mode;
        delete data.run_mode;
        const endpoint = getEndpoint(runMode);
        var taskType = 'backtest';
        if (runMode === 'compare') taskType = 'compare';
        else if (runMode === 'sweep') taskType = 'sweep';
        else if (runMode === 'multi') taskType = 'multi';

        // Show loading
        btn.disabled = true;
        loadingEl.classList.remove('hidden');
        if (runMode === 'sweep') {
            loadingMsg.textContent = 'Running parameter sweep... this may take a while.';
        } else if (runMode === 'compare') {
            loadingMsg.textContent = 'Running strategy comparison...';
        } else if (runMode === 'multi') {
            loadingMsg.textContent = 'Running multi-pair backtest across ' + (data.symbols ? data.symbols.length : 0) + ' pairs...';
        } else {
            loadingMsg.textContent = 'Running backtest...';
        }

        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        })
        .then(function(resp) { return resp.json(); })
        .then(function(result) {
            if (result.error) {
                showError(result.error);
                btn.disabled = false;
                return;
            }
            pollStatus(result.task_id, taskType);
        })
        .catch(function(err) {
            showError('Failed to start backtest: ' + err.message);
            btn.disabled = false;
            loadingEl.classList.add('hidden');
        });
    });
})();
</script>
{% endblock %}
