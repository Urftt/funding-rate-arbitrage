<div id="equity-curve-section" class="bg-dash-card rounded-lg border border-dash-border p-4">
    <h3 class="text-white font-semibold mb-2">Equity Curve</h3>
    <div style="position: relative; height: 300px;">
        <canvas id="equity-chart"></canvas>
    </div>
</div>

<script>
/**
 * Render an equity curve chart using Chart.js.
 *
 * @param {Array} equityData - Array of {timestamp_ms, equity} objects.
 * @param {string} label - Dataset label (e.g., "Simple" or "Composite").
 * @param {string} color - Line color hex string.
 * @param {Array} [trades] - Optional array of trade objects with entry_time_ms and exit_time_ms.
 */
function renderEquityCurve(equityData, label, color, trades) {
    const ctx = document.getElementById('equity-chart').getContext('2d');

    // Destroy previous chart if it exists
    if (window._equityChart) {
        window._equityChart.destroy();
    }

    const labels = equityData.map(p => {
        const d = new Date(p.timestamp_ms);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    const values = equityData.map(p => parseFloat(p.equity));

    // Build timestamp-to-index lookup for trade markers
    var tsToIndex = {};
    equityData.forEach(function(p, idx) { tsToIndex[p.timestamp_ms] = idx; });

    // Build entry and exit point arrays from trades (if provided and non-empty)
    var entryPoints = [];
    var exitPoints = [];
    if (trades && trades.length > 0) {
        trades.forEach(function(t) {
            var entryIdx = tsToIndex[t.entry_time_ms];
            if (entryIdx !== undefined) {
                entryPoints.push({ x: entryIdx, y: values[entryIdx] });
            }
            var exitIdx = tsToIndex[t.exit_time_ms];
            if (exitIdx !== undefined) {
                exitPoints.push({ x: exitIdx, y: values[exitIdx] });
            }
        });
    }

    // Build datasets: equity line + optional scatter markers
    var datasets = [{
        label: label || 'Equity',
        data: values,
        borderColor: color || '#22c55e',
        backgroundColor: (color || '#22c55e') + '1a',
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 4,
    }];

    if (entryPoints.length > 0) {
        datasets.push({
            type: 'scatter',
            label: 'Entry',
            data: entryPoints,
            pointStyle: 'triangle',
            pointRadius: 7,
            pointHoverRadius: 10,
            backgroundColor: '#22c55e',
            borderColor: '#166534',
            borderWidth: 1,
            showLine: false,
        });
    }

    if (exitPoints.length > 0) {
        datasets.push({
            type: 'scatter',
            label: 'Exit',
            data: exitPoints,
            pointStyle: 'triangle',
            rotation: 180,
            pointRadius: 7,
            pointHoverRadius: 10,
            backgroundColor: '#ef4444',
            borderColor: '#991b1b',
            borderWidth: 1,
            showLine: false,
        });
    }

    window._equityChart = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            resizeDelay: 100,
            plugins: {
                legend: {
                    labels: { color: '#9ca3af' }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    position: 'nearest',
                    callbacks: {
                        label: function(context) {
                            if (context.dataset.type === 'scatter') {
                                return context.dataset.label + ' at $' + context.parsed.y.toFixed(2);
                            }
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#6b7280', maxTicksLimit: 12 },
                    grid: { color: '#334155' }
                },
                y: {
                    ticks: {
                        color: '#6b7280',
                        callback: function(v) { return '$' + v.toFixed(0); }
                    },
                    grid: { color: '#334155' }
                }
            }
        }
    });
}

/**
 * Render a comparison equity curve with two datasets on the same chart.
 *
 * @param {Array} simpleData - Array of {timestamp_ms, equity} for simple strategy.
 * @param {Array} compositeData - Array of {timestamp_ms, equity} for composite strategy.
 */
function renderComparisonEquityCurve(simpleData, compositeData) {
    const ctx = document.getElementById('equity-chart').getContext('2d');

    if (window._equityChart) {
        window._equityChart.destroy();
    }

    // Use the longer dataset for labels
    const longerData = simpleData.length >= compositeData.length ? simpleData : compositeData;
    const labels = longerData.map(p => {
        const d = new Date(p.timestamp_ms);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    window._equityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Simple (v1.0)',
                    data: simpleData.map(p => parseFloat(p.equity)),
                    borderColor: '#3b82f6',
                    backgroundColor: '#3b82f61a',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                },
                {
                    label: 'Composite (v1.1)',
                    data: compositeData.map(p => parseFloat(p.equity)),
                    borderColor: '#22c55e',
                    backgroundColor: '#22c55e1a',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            resizeDelay: 100,
            plugins: {
                legend: {
                    labels: { color: '#9ca3af' }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    position: 'nearest',
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#6b7280', maxTicksLimit: 12 },
                    grid: { color: '#334155' }
                },
                y: {
                    ticks: {
                        color: '#6b7280',
                        callback: function(v) { return '$' + v.toFixed(0); }
                    },
                    grid: { color: '#334155' }
                }
            }
        }
    });
}
</script>
